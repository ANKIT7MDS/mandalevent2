<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>मंडल में सम्पन्न हुए विभिन्न संगठनात्मक कार्यक्रम</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f4f6fa;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
            color: #1c2942; margin: 0; padding: 0;
        }
        .container-tv {
            max-width: 1380px; margin: 12px auto 8px auto;
            background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #e6a74912;
            padding: 12px 2vw 20px 2vw; position: relative;
        }
        .tv-title-bar {
            display: flex; align-items: center; border-bottom: 3px solid #ff9800;
            padding-bottom: 6px; margin-bottom: 10px; gap: 12px;
        }
        .tv-logo { width: 46px; height: 46px; min-width: 46px; background: linear-gradient(120deg,#ffe1b9,#ffc46d); border:2.5px solid #fff3e0; border-radius:50%; font-weight:700; font-size:1.25rem; color:#e65100; display:flex;align-items:center;justify-content:center;}
        .tv-title-main { font-size: 1.28rem; font-weight: 700; color: #263b64; white-space: normal; word-break: break-word; max-width: 82vw;}
        .tv-pagination {margin-left:auto;font-size:1.07rem;font-weight:600;color:#b78937;}
        .tv-controls {display:flex;justify-content:center;gap:13px;margin:20px 0 3px 0;flex-wrap:wrap;}
        .tv-controls button {background:#ff9800;color:#fff;font-weight:600;border:none;border-radius:9px;padding:12px 24px;font-size:1.18rem;cursor:pointer;transition:background 0.12s;letter-spacing:1px;}
        .tv-controls .autoplay-btn {background:#1976d2;}
        .tv-controls .autoplay-btn.active {background:#44a62c;}
        .tv-controls .pdf-btn {background:#5e35b1;}
        .tv-controls .pdf-btn:hover {background:#4527a0;}
        /* -------- Main Flex -------- */
        .slideshow-section {
            display: flex; flex-direction: row; gap: 24px; margin-bottom: 12px;
            align-items: flex-start;
            min-height: 450px;
        }
        .slide-card {
            background:#f8fafc; border-radius:14px; box-shadow:0 2px 16px #ffe9d72a; padding:19px 22px 14px 18px; min-width:320px; flex:1 1 58%; max-width:700px;
        }
        .slide-title { font-size:1.18rem; font-weight:700; color:#d07011; margin-bottom:9px;}
        .slide-details-row { font-size:1.09rem; margin:4px 0;}
        .slide-details-row span {color:#77530e;font-weight:500;min-width:74px;display:inline-block;}
        .slide-description {font-size:1.07rem; margin:13px 0 2px 0; color:#212427; line-height:1.48;}
        /* ---- Gallery RIGHT ---- */
        .slide-gallery-card {
            background:#fffaf3; border-radius:13px; box-shadow:0 2px 10px #ffe9d744;
            padding:18px 1vw 16px 1vw; min-width: 280px; max-width: 380px; flex: 0 0 32%;
        }
        .gallery-title {font-size:1.08rem;font-weight:700;color:#d07011;margin-bottom:9px;border-left:4px solid #ff9800;padding-left:10px;}
        .gallery-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 13px 12px;}
        .gallery-img-box {position:relative; border-radius:10px; overflow:hidden; aspect-ratio:4/3; background:#fff; min-width:0;}
        .gallery-img-box img {width:100%;height:100%;object-fit:cover;object-position:center center;border-radius:10px;display:block;background:#fff;cursor:pointer;position:absolute;left:0;top:0;touch-action:none;}
        .view-btn,.edit-btn {position:absolute;bottom:8px;padding:4.5px 13px 4.5px 13px;font-size:1.01rem;font-weight:600;border:none;outline:none;cursor:pointer;border-radius:7px;box-shadow:0 1px 7px #ff98004a;transition:background 0.12s;}
        .view-btn {right:10px;background:#ff9800;color:#fff;}
        .edit-btn {right:83px;background:#1976d2;color:#fff;}
        .edit-btn:hover {background:#0d47a1;} .view-btn:hover {background:#e65100;}
        #imgZoomModal {display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.87);align-items:center;justify-content:center;}
        #imgZoomModal img {max-width:97vw;max-height:93vh;border-radius:11px;border:2px solid #fff;background:#fff;box-shadow:0 0 10px #ff9800a7;}
        #adjustViewModal {display:none;position:fixed;z-index:5000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;}
        #adjustViewModal .modal-box {background:#fff;padding:8px 6px;border-radius:9px;box-shadow:0 2px 14px #ff980055;display:flex;flex-direction:column;align-items:center;width:98vw;max-width:400px;}
        #adjustViewModal .drag-box {position:relative;width:98vw;max-width:340px;height:245px;overflow:hidden;border-radius:9px;background:#eee;}
        #adjViewImg {position:absolute;left:0;top:0;cursor:grab;min-width:100%;min-height:100%;user-select:none;touch-action:none;}
        #adjustViewModal .abtns {margin-top:12px;text-align:center;display:flex;gap:18px;}
        #adjustViewModal button {padding: 8px 15px; border-radius:9px; border:none; background:#ff9800; color:#fff; font-size:1.08rem; font-weight:600; cursor:pointer;}
        #adjustViewModal button:hover { background: #d27e13;}
       @media (max-width:700px) {
    .slideshow-section {flex-direction:column;}
    .slide-card {max-width:99vw;}
    .slide-gallery-card {
        max-width:98vw;
        min-width:0;
        padding:11px 2vw 16px 2vw;
        margin-top:10px;
        margin-left:0;
    }
    .gallery-title {font-size:1.07rem;}
    .gallery-grid {
        grid-template-columns: 1fr 1fr;
        gap: 13px 12px;
    }
    .gallery-img-box {
        border-radius:9px;
        min-width: 0;
        height: 30vw;      /* height बड़ा किया */
        min-height:110px;
        max-height:165px;
        aspect-ratio:4/3;
    }
    .gallery-img-box img {
        border-radius:9px;
        object-fit:cover;
        object-position:center center;
        width:100%; height:100%;
        position:absolute; left:0; top:0;
    }
}

    </style>
    <!-- PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/iamdual/jsPDF-NotoSansDevanagari/dist/NotoSansDevanagari.js"></script>
</head>
<body>
<div class="container-tv">
    <div class="tv-title-bar">
        <div class="tv-logo">BJ</div>
        <div class="tv-title-main">मंडल में सम्पन्न हुए विभिन्न संगठनात्मक कार्यक्रम</div>
        <div class="tv-pagination" id="tv-pagination">1 / 1</div>
    </div>
    <div class="slideshow-section" id="tv-slideshow"></div>
    <div class="tv-controls">
        <button onclick="prevSlide()">&#8592; पिछला</button>
        <button onclick="nextSlide()">अगला &#8594;</button>
        <button class="autoplay-btn" id="autoplayBtn" onclick="toggleAutoplay()">टीवी-मोड</button>
        <button class="pdf-btn" onclick="downloadPDF()">PDF</button>
    </div>
</div>
<!-- फोटो Zoom Modal -->
<div id="imgZoomModal">
    <img id="imgZoomModalImg" src="">
</div>
<!-- फोटो Adjust View Modal -->
<div id="adjustViewModal">
    <div class="modal-box">
        <div class="drag-box">
            <img id="adjViewImg" src="">
        </div>
        <div class="abtns">
            <button onclick="saveViewPos()">सेव</button>
            <button onclick="closeAdjView()">कैंसिल</button>
        </div>
    </div>
</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, collection, getDocs, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let reports = [];
let slideIndex = 0;
let autoplay = false, autoplayInterval = null;

async function loadReports() {
    const eventNamesSnap = await getDocs(collection(db, "eventNames"));
    const eventNames = {};
    eventNamesSnap.forEach(docSnap => {
        eventNames[docSnap.id] = docSnap.data().name || '';
    });
    let allReports = [];
    for (const eventNameId of Object.keys(eventNames)) {
        const reportSnap = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        reportSnap.forEach(docSnap => {
            const r = docSnap.data();
            let photoOffsets = Array.isArray(r.photoOffsets) ? r.photoOffsets : [];
            allReports.push({
                ...r,
                id: docSnap.id,
                eventNameId,
                eventName: eventNames[eventNameId],
                photoOffsets
            });
        });
    }
    allReports.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    reports = allReports;
    showSlide(0);
}
window.prevSlide = function() {
    if (!reports.length) return;
    slideIndex = (slideIndex-1+reports.length) % reports.length;
    showSlide(slideIndex);
}
window.nextSlide = function() {
    if (!reports.length) return;
    slideIndex = (slideIndex+1)%reports.length;
    showSlide(slideIndex);
}
window.toggleAutoplay = function() {
    autoplay = !autoplay;
    let btn = document.getElementById('autoplayBtn');
    btn.classList.toggle('active', autoplay);
    btn.textContent = autoplay ? "टीवी-मोड बंद करें" : "टीवी-मोड";
    if (autoplay) {
        autoplayInterval = setInterval(() => {
            nextSlide();
        }, 4000);
    } else {
        clearInterval(autoplayInterval);
    }
}
function showSlide(idx) {
    if (!reports.length) {
        document.getElementById('tv-slideshow').innerHTML = `<div style="color:#d07a1a;font-size:1.2rem;">कोई रिपोर्ट डेटा उपलब्ध नहीं है।</div>`;
        document.getElementById('tv-pagination').innerText = "";
        return;
    }
    slideIndex = idx;
    const r = reports[idx];
    let detailsHtml = `
    <div class="slide-card">
        <div class="slide-title">${r.eventName || 'कार्यक्रम'}</div>
        <div class="slide-details">
            <div class="slide-details-row"><span>तारीख:</span> ${r.date || '-'}</div>
            <div class="slide-details-row"><span>स्थान:</span> ${r.location || '-'}</div>
            <div class="slide-details-row"><span>मंडल:</span> ${r.mandal || '-'}</div>
            <div class="slide-details-row"><span>प्रकार:</span> ${r.type || (r.prakar||'कार्यक्रम')}</div>
            <div class="slide-details-row"><span>उपस्थिति:</span> ${r.attendance || '-'}</div>
            <div class="slide-details-row"><span>अतिथि:</span> ${r.guests || '-'}</div>
        </div>
        <div class="slide-description">${(r.details||'').replace(/\n/g,'<br>')}</div>
        ${r.hashtag ? `<div class="slide-details-row" style="margin-top:7px;color:#4a7dc0;">#${r.hashtag}</div>` : ''}
    </div>
    `;
    let photos = (Array.isArray(r.photos) ? r.photos : []);
    let showPhotos = [];
    for(let i=0;i<4;i++){
        showPhotos.push(photos[i] ? photos[i] : "https://dummyimage.com/600x450/eee/aaa&text=No+Photo");
    }
    let photoOffsets = Array.isArray(r.photoOffsets) ? r.photoOffsets : [];
    let galleryHtml = `<div class="slide-gallery-card">
        <div class="gallery-title">फोटो गैलरी</div>
        <div class="gallery-grid">`;
    showPhotos.forEach((url, pidx) => {
        let pos = photoOffsets[pidx] || {x:0, y:0};
        let style = `left:${pos.x||0}px; top:${pos.y||0}px;`;
        galleryHtml += `
        <div class="gallery-img-box">
            <img src="${url}" alt="कार्यक्रम फोटो" style="${style}" onclick="zoomImage(event, '${url}')">
            <button class="edit-btn" onclick="openAdjView(${idx},${pidx},'${url}')">सेट व्यू</button>
            <button class="view-btn" onclick="zoomImage(event, '${url}')">देखें</button>
        </div>`;
    });
    galleryHtml += `</div></div>`;
    document.getElementById('tv-slideshow').innerHTML = detailsHtml + galleryHtml;
    document.getElementById('tv-pagination').innerText = `${idx+1} / ${reports.length}`;
}
window.zoomImage = function(e, url) {
    e.preventDefault();
    document.getElementById('imgZoomModalImg').src = url;
    document.getElementById('imgZoomModal').style.display = 'flex';
};
document.getElementById('imgZoomModal').onclick = function() {
    this.style.display = 'none';
    document.getElementById('imgZoomModalImg').src = '';
};
let dragData = {isDrag:false, startX:0, startY:0, imgX:0, imgY:0, boxW:340, boxH:245};
let adjIdx = null, adjPidx = null;
window.openAdjView = function(idx, pidx, url) {
    adjIdx = idx; adjPidx = pidx;
    document.getElementById('adjViewImg').src = url;
    let pos = ((reports[idx]||{}).photoOffsets||[])[pidx] || {x:0,y:0};
    let img = document.getElementById('adjViewImg');
    img.onload = function() {
        img.style.left = (pos.x||0)+"px";
        img.style.top = (pos.y||0)+"px";
        dragData.imgX = parseInt(img.style.left)||0;
        dragData.imgY = parseInt(img.style.top)||0;
    }
    setTimeout(() => {
        dragData.imgX = pos.x||0; dragData.imgY = pos.y||0;
        dragData.isDrag = false;
    }, 120);
    document.getElementById('adjustViewModal').style.display = 'flex';
};
document.getElementById('adjViewImg').addEventListener('touchstart', function(e){
    dragData.isDrag = true;
    let touch = e.touches[0];
    dragData.startX = touch.clientX;
    dragData.startY = touch.clientY;
    dragData.imgX = parseInt(this.style.left)||0;
    dragData.imgY = parseInt(this.style.top)||0;
});
document.getElementById('adjViewImg').addEventListener('mousedown', function(e){
    dragData.isDrag = true;
    dragData.startX = e.clientX;
    dragData.startY = e.clientY;
    dragData.imgX = parseInt(this.style.left)||0;
    dragData.imgY = parseInt(this.style.top)||0;
});
window.addEventListener('mousemove', function(e){
    if(!dragData.isDrag) return;
    let dx = e.clientX - dragData.startX;
    let dy = e.clientY - dragData.startY;
    let img = document.getElementById('adjViewImg');
    let boxW = dragData.boxW, boxH = dragData.boxH;
    let imgRatio = img.naturalWidth/img.naturalHeight;
    let scaleW = Math.max(boxW, boxH*imgRatio), scaleH = Math.max(boxH, boxW/imgRatio);
    let imgW = scaleW, imgH = scaleW/imgRatio;
    if (imgH < boxH) { imgH = boxH; imgW = boxH*imgRatio; }
    let minX = boxW-imgW, minY = boxH-imgH;
    let nx = Math.min(0, Math.max(minX, dragData.imgX + dx));
    let ny = Math.min(0, Math.max(minY, dragData.imgY + dy));
    img.style.left = nx + "px";
    img.style.top = ny + "px";
});
window.addEventListener('touchmove', function(e){
    if(!dragData.isDrag) return;
    let touch = e.touches[0];
    let dx = touch.clientX - dragData.startX;
    let dy = touch.clientY - dragData.startY;
    let img = document.getElementById('adjViewImg');
    let boxW = dragData.boxW, boxH = dragData.boxH;
    let imgRatio = img.naturalWidth/img.naturalHeight;
    let scaleW = Math.max(boxW, boxH*imgRatio), scaleH = Math.max(boxH, boxW/imgRatio);
    let imgW = scaleW, imgH = scaleW/imgRatio;
    if (imgH < boxH) { imgH = boxH; imgW = boxH*imgRatio; }
    let minX = boxW-imgW, minY = boxH-imgH;
    let nx = Math.min(0, Math.max(minX, dragData.imgX + dx));
    let ny = Math.min(0, Math.max(minY, dragData.imgY + dy));
    img.style.left = nx + "px";
    img.style.top = ny + "px";
});
window.addEventListener('mouseup', function(){ dragData.isDrag = false; });
window.addEventListener('touchend', function(){ dragData.isDrag = false; });
window.closeAdjView = function() {
    document.getElementById('adjustViewModal').style.display = 'none';
};
window.saveViewPos = async function() {
    let img = document.getElementById('adjViewImg');
    let left = parseInt(img.style.left)||0;
    let top = parseInt(img.style.top)||0;
    let r = reports[adjIdx];
    let photoOffsets = Array.isArray(r.photoOffsets)? r.photoOffsets : [];
    photoOffsets[adjPidx] = {x:left, y:top};
    await updateDoc(doc(db, `eventNames/${r.eventNameId}/reports`, r.id), { photoOffsets });
    reports[adjIdx].photoOffsets = photoOffsets;
    alert("सेट हो गया!");
    closeAdjView();
    showSlide(slideIndex);
};
window.downloadPDF = function() {
    if (!reports[slideIndex]) return;
    let r = reports[slideIndex];
    const doc = new jspdf.jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
    doc.addFileToVFS("NotoSansDevanagari-Regular-normal.ttf", window.NotoSansDevanagariNormal);
    doc.addFont("NotoSansDevanagari-Regular-normal.ttf", "NotoSansDevanagari", "normal");
    doc.setFont("NotoSansDevanagari");
    doc.setFontSize(19);
    doc.text(r.eventName || 'कार्यक्रम', 45, 44, {lang:"hi"});
    doc.setFontSize(13);
    let y = 72;
    let details = [
        ["तारीख", r.date||'-'], ["स्थान", r.location||'-'], ["मंडल", r.mandal||'-'],
        ["प्रकार", r.type||(r.prakar||'कार्यक्रम')], ["उपस्थिति", r.attendance||'-'],
        ["अतिथि", r.guests||'-']
    ];
    doc.autoTable({
        startY: y, head:[["फील्ड", "विवरण"]], body: details,
        styles:{ font:"NotoSansDevanagari", fontSize:13 }
    });
    y = doc.lastAutoTable.finalY + 18;
    doc.text("कार्यक्रम विवरण:", 45, y, {lang:"hi"});
    y+=19;
    let desc = (r.details||'-').replace(/\n/g," ");
    doc.text(desc, 55, y, {maxWidth:720,lang:"hi"});
    let photos = (Array.isArray(r.photos)?r.photos:[]).slice(0,1);
    let imgY = y+33;
    if(photos.length){
        let img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
            doc.addImage(img, "JPEG", 60, imgY, 260, 180);
            doc.save((r.eventName||'report')+".pdf");
        };
        img.onerror = function() { doc.save((r.eventName||'report')+".pdf"); };
        img.src = photos[0];
    } else {
        doc.save((r.eventName||'report')+".pdf");
    }
};
loadReports();
</script>
</body>
</html>
