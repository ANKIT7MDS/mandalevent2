<!DOCTYPE html>
const TELEGRAM_CHAT_ID = "733804072";
async function sendTelegramAlert(text){
try{ await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text }) }); }catch(e){ console.warn('Telegram error',e); }
}


document.addEventListener('DOMContentLoaded', async () => {
const sel = document.getElementById('coordMandal');
mandals.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
await loadEventNames();
});


async function loadEventNames(){
const eventSelect = document.getElementById('eventSelect');
eventSelect.innerHTML = '<option value="">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
const snap = await getDocs(collection(db,'eventNames'));
const sorted = snap.docs.sort((a,b)=> (a.data().name||'').localeCompare(b.data().name||'','hi'));
for(const d of sorted){ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; eventSelect.appendChild(opt); }
}


function showSummaryPopup(data){
const summary = Object.entries(data).map(([k,v])=>`<b>${k}</b>: ${v||'-'}`).join('<br>');
const wrap = document.createElement('div');
wrap.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;alignItems:center;justifyContent:center;zIndex:5000';
wrap.innerHTML = `<div style="background:#fff;max-width:460px;width:92%;padding:18px;border-radius:12px;">
<h3 style="margin:0 0 8px 0;">‡§≠‡§∞‡•Ä ‡§ó‡§à ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3>
<div style="font-size:14px;line-height:1.45">${summary}</div>
<div style="margin-top:10px;color:#d35400;font-size:12px;">‡§á‡§∏‡§ï‡§æ screenshot ‡§≤‡•á‡§ï‡§∞ ‡§Ö‡§™‡§®‡•á ‡§™‡§æ‡§∏ ‡§∞‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç</div>
<div style="text-align:right;margin-top:12px;"><button onclick="this.closest('div').parentElement.remove()">OK</button></div>
</div>`;
document.body.appendChild(wrap);
}


document.getElementById('coordinatorForm').addEventListener('submit', async (e)=>{
e.preventDefault();
const eventNameId = document.getElementById('eventSelect').value;
const payload = {
eventNameId,
mandal: document.getElementById('coordMandal').value,
name: document.getElementById('coordName').value,
mobile: document.getElementById('coordMobile').value,
coCoordName1: document.getElementById('coCoordName1').value,
coCoordMobile1: document.getElementById('coCoordMobile1').value,
coCoordName2: document.getElementById('coCoordName2').value,
coCoordMobile2: document.getElementById('coCoordMobile2').value
};
try{
await addDoc(collection(db,`eventNames/${eventNameId}/coordinators`), payload);
// Count unique mandals that have coordinator for this event
const snap = await getDocs(collection(db,`eventNames/${eventNameId}/coordinators`));
const doneSet = new Set(); snap.forEach(d=>{ const c=d.data(); if(c.mandal) doneSet.add(c.mandal); });
const done=[...doneSet]; const remaining = mandals.filter(m=> !doneSet.has(m));
await sendTelegramAlert(`‚úÖ COORDINATOR | ${eventNameId}\n${payload.mandal} ‡§®‡•á submit ‡§ï‡§ø‡§Ø‡§æ.\n\nPoore hue (${done.length}/21):\n- ${done.join('\n- ')}\n\nBache hue (${remaining.length}):\n- ${remaining.join('\n- ')}`);
if(done.length===21){ await sendTelegramAlert(`üéâ COORDINATOR | ${eventNameId}: Sabhi 21/21 Mandal complete!`); }
showSummaryPopup(payload);
alert('‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!');
e.target.reset();
}catch(err){ alert('Error: '+err.message); }
});
</script>
</body>
</html>
