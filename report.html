<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>रिपोर्ट सबमिट करें</title>
    <style>
        body { background:#fdf3e4; }
        .report-form { max-width:410px; margin:36px auto; background:#fff8ee; padding:30px 24px 20px 24px; border-radius:16px; box-shadow:0 6px 28px #c85a0033; font-family:'Noto Sans Devanagari', Arial, sans-serif; }
        .report-form label { font-weight:600; margin-top:15px; display:block; color:#e65100; }
        .report-form input, .report-form select, .report-form textarea { width:100%; padding:9px 12px; margin-bottom:12px; font-size:1.08rem; border:1px solid #ffd9b3; border-radius:7px; }
        .report-form textarea { min-height:70px; }
        #reportSubmitBtn { background:#ff9800; color:#fff; font-size:1.12rem; padding:9px 0; border:none; border-radius:7px; cursor:pointer; margin-top:10px; }
        #reportSubmitBtn[disabled] { background:#e65100; color:#fff1e3; cursor:wait; }
    </style>
    <!-- Firebase 8 CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <form class="report-form" id="reportForm">
        <h2 style="color:#e65100;text-align:center;margin-bottom:18px;">रिपोर्ट फॉर्म</h2>
        <label>कार्यक्रम का नाम</label>
        <select id="reportEventName" required>
            <option value="">कार्यक्रम का नाम चुनें</option>
            <!-- JS से load होंगे -->
        </select>

        <label>मंडल</label>
        <select id="reportMandal" required>
            <option value="">-- मंडल चुनें --</option>
            <!-- JS से load होंगे -->
        </select>

        <label>स्थान</label>
        <input id="reportLocation" type="text" placeholder="जहाँ कार्यक्रम संपन्न हुआ वह स्थान लिखें" required>

        <label>उपस्थिति</label>
        <input id="reportAttendance" type="number" placeholder="कार्यक्रम में कुल उपस्थित संख्या" required>

        <label>विशिष्ट अतिथि</label>
        <input id="reportGuests" type="text" placeholder="विशिष्ट अतिथि, जनप्रतिनिधि,प्रभारी, वक्ता आदि">

        <label>विवरण</label>
        <textarea id="reportDetails" placeholder="कार्यक्रम का संक्षिप्त विवरण" required></textarea>

        <label>फोटो अपलोड करें</label>
        <input id="reportPhoto" type="file" accept="image/*" multiple required>

        <button id="reportSubmitBtn" type="submit">रिपोर्ट सबमिट करें</button>
    </form>

    <script>
    // ========= YOUR FIREBASE CONFIG ==========
    var firebaseConfig = {
        apiKey: "AIzaSyCMoE8dpQzCrp7_3gfZcfw5qmnVXvFaySk",
        authDomain: "mandalevent2.firebaseapp.com",
        projectId: "mandalevent2",
        storageBucket: "mandalevent2.appspot.com",
        messagingSenderId: "1026124927942",
        appId: "1:1026124927942:web:3e7f7e0f35482a34f2d221"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();

    // Dropdown (कार्यक्रम नाम + मंडल)
    function populateDropdowns() {
        db.collection("eventNames").get().then(qs => {
            let select = document.getElementById("reportEventName");
            qs.forEach(doc => {
                let opt = document.createElement("option");
                opt.value = doc.data().name;
                opt.innerText = doc.data().name;
                select.appendChild(opt);
            });
        });
        db.collection("mandals").get().then(qs => {
            let select = document.getElementById("reportMandal");
            qs.forEach(doc => {
                let opt = document.createElement("option");
                opt.value = doc.data().name;
                opt.innerText = doc.data().name;
                select.appendChild(opt);
            });
        });
    }
    window.onload = populateDropdowns;

    // Form Submit
    let isSubmitting = false;
    document.getElementById("reportForm").addEventListener("submit", async function(e){
        e.preventDefault();
        if(isSubmitting) return;
        isSubmitting = true;
        const btn = document.getElementById("reportSubmitBtn");
        btn.disabled = true;
        btn.textContent = "Uploading... कृपया प्रतीक्षा करें";

        // Get form data
        const eventName = document.getElementById("reportEventName").value;
        const mandal = document.getElementById("reportMandal").value;
        const location = document.getElementById("reportLocation").value;
        const attendance = document.getElementById("reportAttendance").value;
        const guests = document.getElementById("reportGuests").value;
        const details = document.getElementById("reportDetails").value;
        const files = document.getElementById("reportPhoto").files;

        try {
            // फोटो upload
            let photoURLs = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const storageRef = storage.ref().child(`reports/${Date.now()}_${file.name}`);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                photoURLs.push(url);
            }

            // Firestore में सेव
            await db.collection("reports").add({
                eventName, mandal, location, attendance, guests, details,
                photos: photoURLs,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            btn.textContent = "Success!";
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "रिपोर्ट सबमिट करें";
                isSubmitting = false;
            }, 1000);
            document.getElementById("reportForm").reset();
            alert("रिपोर्ट सफलतापूर्वक सेव हो गई!");
        } catch(err) {
            alert("Upload error!\n" + err.message);
            btn.disabled = false;
            btn.textContent = "रिपोर्ट सबमिट करें";
            isSubmitting = false;
        }
    });
    </script>
</body>
</html>
