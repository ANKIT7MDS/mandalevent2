<!DOCTYPE html>
});


async function loadEventNames(){
const eventSelect = document.getElementById('reportEventSelect');
eventSelect.innerHTML = '<option value="">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
const qs = await getDocs(collection(db,'eventNames'));
qs.forEach(doc=>{
const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=doc.data().name; eventSelect.appendChild(opt);
});
}


function showSummaryPopup(data){
const summary = Object.entries(data).map(([k,v])=>`<b>${k}</b>: ${Array.isArray(v)? v.join(', '):(v||'-')}`).join('<br>');
const wrap = document.createElement('div');
wrap.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:5000';
wrap.innerHTML = `<div style="background:#fff;max-width:480px;width:92%;padding:18px;border-radius:12px;">
<h3 style="margin:0 0 8px 0;">‡§≠‡§∞‡•Ä ‡§ó‡§à ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3>
<div style="font-size:14px;line-height:1.45">${summary}</div>
<div style="margin-top:10px;color:#d35400;font-size:12px;">‡§á‡§∏‡§ï‡§æ screenshot ‡§≤‡•á‡§ï‡§∞ ‡§Ö‡§™‡§®‡•á ‡§™‡§æ‡§∏ ‡§∞‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç</div>
<div style="text-align:right;margin-top:12px;"><button onclick="this.closest('div').parentElement.remove()">OK</button></div>
</div>`;
document.body.appendChild(wrap);
}


document.getElementById('reportForm').addEventListener('submit', async (e) => {
e.preventDefault();
const submitBtn = document.getElementById('submitBtn');
const loadingDiv = document.getElementById('loadingMessage');
submitBtn.disabled = true; loadingDiv.style.display = 'block';


const eventNameId = document.getElementById('reportEventSelect').value;
const files = document.getElementById('photos').files;
const photoUrls = [];
try {
for (let file of files) {
const storageRef = ref(storage, `reports/${eventNameId}/${file.name}`);
await uploadBytes(storageRef, file);
const url = await getDownloadURL(storageRef);
photoUrls.push(url);
}
const reportData = {
eventNameId,
mandal: document.getElementById('reportMandal').value,
location: document.getElementById('reportLocation').value,
attendance: document.getElementById('attendance').value,
reportDate: document.getElementById('reportDate').value,
guests: document.getElementById('guests').value,
details: document.getElementById('details').value,
photos: photoUrls
};
await addDoc(collection(db, `eventNames/${eventNameId}/reports`), reportData);


// Done / Remaining calc for REPORTS of this program
const all = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
const doneSet = new Set(); all.forEach(d=>{ const r=d.data(); if(r.mandal) doneSet.add(r.mandal); });
const done=[...doneSet]; const remaining = mandals.filter(m=>!doneSet.has(m));
await sendTelegramAlert(`‚úÖ REPORT | ${eventNameId}\n${reportData.mandal} ‡§®‡•á submit ‡§ï‡§ø‡§Ø‡§æ.\n\nPoore hue (${done.length}/21):\n- ${done.join('\n- ')}\n\nBache hue (${remaining.length}):\n- ${remaining.join('\n- ')}`);
if(done.length===21){ await sendTelegramAlert(`üéâ REPORT | ${eventNameId}: Sabhi 21/21 Mandal complete!`); }


showSummaryPopup(reportData);
alert('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡•Ä ‡§ó‡§à!');
document.getElementById('reportForm').reset();
} catch (error) {
alert('Error: ' + error.message);
}
submitBtn.disabled = false; loadingDiv.style.display = 'none';
});
</script>
</body>
</html>
