<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>रिपोर्ट फॉर्म</title>
    <style>
        body { background:#fdf3e4; }
        .report-form { max-width:410px; margin:36px auto; background:#fff8ee; padding:30px 24px 20px 24px; border-radius:16px; box-shadow:0 6px 28px #c85a0033; font-family:'Noto Sans Devanagari', Arial, sans-serif; }
        .report-form label { font-weight:600; margin-top:15px; display:block; color:#e65100; }
        .report-form input, .report-form select, .report-form textarea { width:100%; padding:9px 12px; margin-bottom:12px; font-size:1.08rem; border:1px solid #ffd9b3; border-radius:7px; }
        .report-form textarea { min-height:70px; }
        #reportSubmitBtn { background:#ff9800; color:#fff; font-size:1.12rem; padding:9px 0; border:none; border-radius:7px; cursor:pointer; margin-top:10px; }
        #reportSubmitBtn[disabled] { background:#e65100; color:#fff1e3; cursor:wait; }
    </style>
    <!-- Firebase 10 CDN (Compat for Old Syntax) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
</head>
<body>
    <form class="report-form" id="reportForm" autocomplete="off">
        <h2 style="color:#e65100;text-align:center;margin-bottom:18px;">रिपोर्ट फॉर्म</h2>
        <label>कार्यक्रम का नाम</label>
        <select id="reportEventSelect" required>
            <option value="">कार्यक्रम का नाम चुनें</option>
        </select>

        <label>मंडल</label>
        <select id="reportMandal" required>
            <option value="">-- मंडल चुनें --</option>
        </select>

        <label>स्थान</label>
        <input id="reportLocation" type="text" placeholder="जहाँ कार्यक्रम संपन्न हुआ वह स्थान लिखें" required>

        <label>उपस्थिति</label>
        <input id="attendance" type="number" placeholder="कार्यक्रम में कुल उपस्थित संख्या" required>

        <label>विशिष्ट अतिथि</label>
        <input id="guests" type="text" placeholder="विशिष्ट अतिथि, जनप्रतिनिधि,प्रभारी, वक्ता आदि">

        <label>विवरण</label>
        <textarea id="details" placeholder="कार्यक्रम का संक्षिप्त विवरण" required></textarea>

        <label>फोटो अपलोड करें</label>
        <input id="photos" type="file" accept="image/*" multiple required>

        <button id="reportSubmitBtn" type="submit">रिपोर्ट सबमिट करें</button>
    </form>

    <script>
    // ========= FIXED FIREBASE CONFIG =============
    var firebaseConfig = {
        apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
        authDomain: "mandaleventall.firebaseapp.com",
        projectId: "mandaleventall",
        storageBucket: "mandaleventall.appspot.com", // ✅ ONLY THIS (.appspot.com)
        messagingSenderId: "900190130114",
        appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
        measurementId: "G-2BBZZNRS88"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();

    // मंडल लिस्ट (Firestore से या हार्डकोडेड)
    const mandals = ["भेंसोदा", "भानपुरा", "गरोठ", "मेलखेडा", "खड़ावदा", "शामगढ़", "सुवासरा", "बसाई", "सीतामऊ", "क्यामपुर", "सीतामऊ ग्रामीण", "गुर्जर बरडिया", "धुंधधड़का", "बुढा", "पिपलिया मंडी", "मल्हारगढ़", "दलोदा", "मगरामाता जी", "मंदसौर ग्रामीण", "मंदसौर उत्तर", "मंदसौर दक्षिण"];

    document.addEventListener('DOMContentLoaded', async () => {
        // मंडल लोड करें
        const reportMandalSelect = document.getElementById('reportMandal');
        mandals.forEach(mandal => {
            const option = document.createElement('option');
            option.value = mandal;
            option.textContent = mandal;
            reportMandalSelect.appendChild(option);
        });
        // कार्यक्रम नाम लोड करें
        await loadEventNames();
    });

    async function loadEventNames() {
        const eventSelect = document.getElementById('reportEventSelect');
        eventSelect.innerHTML = '<option value="">कार्यक्रम का नाम चुनें</option>';
        const querySnapshot = await db.collection("eventNames").get();
        querySnapshot.forEach((doc) => {
            const eventName = doc.data().name;
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = eventName;
            eventSelect.appendChild(option);
        });
    }

    // ---- Double Submit Protection + CORS-Proof Upload ----
    let isSubmitting = false;
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(isSubmitting) return;
        isSubmitting = true;
        const submitBtn = document.getElementById('reportSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = "Uploading... कृपया प्रतीक्षा करें";

        const eventNameId = document.getElementById('reportEventSelect').value;
        if (!eventNameId) {
            alert("कृपया कार्यक्रम का नाम चुनें!");
            submitBtn.disabled = false;
            submitBtn.textContent = "रिपोर्ट सबमिट करें";
            isSubmitting = false;
            return;
        }
        const files = document.getElementById('photos').files;
        if (files.length === 0) {
            alert("कम से कम एक फोटो अपलोड करें!");
            submitBtn.disabled = false;
            submitBtn.textContent = "रिपोर्ट सबमिट करें";
            isSubmitting = false;
            return;
        }
        const photoUrls = [];
        try {
            for (let file of files) {
                const storageRef = storage.ref(`reports/${eventNameId}/${Date.now()}_${file.name}`);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                photoUrls.push(url);
            }
            const reportData = {
                eventNameId: eventNameId,
                mandal: document.getElementById('reportMandal').value,
                location: document.getElementById('reportLocation').value,
                attendance: document.getElementById('attendance').value,
                guests: document.getElementById('guests').value,
                details: document.getElementById('details').value,
                photos: photoUrls,
                createdAt: new Date().toISOString()
            };
            // eventNames/{eventNameId}/reports में रिपोर्ट सेव
            await db.collection(`eventNames/${eventNameId}/reports`).add(reportData);

            submitBtn.textContent = "Success!";
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = "रिपोर्ट सबमिट करें";
                isSubmitting = false;
            }, 1200);

            document.getElementById('reportForm').reset();
            alert("रिपोर्ट सफलतापूर्वक सबमिट हो गई!");
        } catch (error) {
            alert("Error: " + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = "रिपोर्ट सबमिट करें";
            isSubmitting = false;
        }
    });
    </script>
</body>
</html>
