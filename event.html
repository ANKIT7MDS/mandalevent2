<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #ffedd2; font-family: 'Segoe UI', Arial, sans-serif; }
        .container { max-width: 450px; margin: 40px auto; background: #ffd89b; border-radius: 16px; box-shadow: 0 2px 16px #ff980044; padding: 36px 22px 28px 22px; }
        h1 { color: #e65100; text-align: center; margin-bottom: 18px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 18px; }
        label { margin-bottom: 6px; font-weight: 500; color: #b85c00; }
        input, select, textarea { padding: 11px 10px; border-radius: 6px; border: 1.5px solid #ffc27b; background: #fffdf6; font-size: 1.1rem; outline: none; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #ff9800; background: #fff7e0; }
        button, input[type="submit"] { width: 100%; background: #ff9800; color: #fff; border: none; border-radius: 7px; padding: 11px 18px; font-size: 1.13rem; font-weight: bold; cursor: pointer; margin-top: 12px; margin-bottom: 5px; transition: background 0.2s;}
        button:hover, input[type="submit"]:hover { background: #e65100; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‡§Ü‡§™ ‡§ï‡•á ‡§Æ‡§Ç‡§°‡§≤ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡•ç‡§™‡•ç‡§™‡§® ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ /‡§¨‡•à‡§†‡§ï ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á </h1>
        <form id="eventForm" autocomplete="off">
            <div class="form-group">
                <label for="eventName">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                <select id="eventName" required>
                    <option value="">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                </select>
            </div>
            <div class="form-group">
                <label for="mandal">‡§Æ‡§Ç‡§°‡§≤</label>
                <select id="mandal" required>
                    <option value="">-- ‡§Æ‡§Ç‡§°‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventDate">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
                <input type="date" id="eventDate" required placeholder="‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç">
            </div>
            <div class="form-group">
                <label for="eventTime">‡§∏‡§Æ‡§Ø</label>
                <input type="time" id="eventTime" required placeholder="‡§∏‡§Æ‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç">
            </div>
            <div class="form-group">
                <label for="location">‡§∏‡•ç‡§•‡§æ‡§®</label>
                <input type="text" id="location" required placeholder="‡§∏‡•ç‡§•‡§æ‡§®">
            </div>
            <button type="submit">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
            authDomain: "mandaleventall.firebaseapp.com",
            projectId: "mandaleventall",
            storageBucket: "mandaleventall.firebasestorage.app",
            messagingSenderId: "900190130114",
            appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
            measurementId: "G-2BBZZNRS88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const mandals = ["‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ","‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ","‡§ó‡§∞‡•ã‡§†","‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ","‡§ñ‡§°‡§º‡§æ‡§µ‡§¶‡§æ","‡§∂‡§æ‡§Æ‡§ó‡•ù","‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ","‡§¨‡§∏‡§æ‡§à","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä","‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ","‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ","‡§¨‡•Å‡§¢‡§æ","‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä","‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù","‡§¶‡§≤‡•ã‡§¶‡§æ","‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£"];

        const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
        const TELEGRAM_CHAT_ID   = "733804072";
        async function sendTelegramAlert(text){
          try{
            await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
              method:'POST',headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
            });
          }catch(e){ console.warn('Telegram error',e); }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const mandalSelect = document.getElementById('mandal');
            mandals.forEach(m => { const o=document.createElement('option'); o.value=m; o.textContent=m; mandalSelect.appendChild(o); });
            await loadEventNames();
        });

        async function loadEventNames() {
            const sel = document.getElementById('eventName');
            sel.innerHTML = '<option value="">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>';
            
            // ‡§ï‡•á‡§µ‡§≤ active ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è query ‡§¨‡§¶‡§≤ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à
            const eventNamesRef = collection(db, "eventNames");
            const q = query(eventNamesRef, where("isActive", "==", true));
            const snap = await getDocs(q);

            const sorted = snap.docs.sort((a,b)=> (a.data().name||'').localeCompare(b.data().name||'','hi'));
            for(const d of sorted){ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; sel.appendChild(opt); }
        }

        function showSummaryPopup(data){
          const summary = Object.entries(data).map(([k,v])=>`<b>${k}</b>: ${v||'-'}`).join('<br>');
          const wrap = document.createElement('div');
          wrap.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:5000';
          wrap.innerHTML = `<div style="background:#fff;max-width:460px;width:92%;padding:18px;border-radius:12px;">
              <h3 style="margin:0 0 8px 0;">‡§≠‡§∞‡•Ä ‡§ó‡§à ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3>
              <div style="font-size:14px;line-height:1.45">${summary}</div>
              <div style="margin-top:10px;color:#d35400;font-size:12px;">‡§á‡§∏‡§ï‡§æ screenshot ‡§≤‡•á‡§ï‡§∞ ‡§Ö‡§™‡§®‡•á ‡§™‡§æ‡§∏ ‡§∞‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç</div>
              <div style="text-align:right;margin-top:12px;"><button onclick="this.closest('div').parentElement.remove()">OK</button></div>
          </div>`;
          document.body.appendChild(wrap);
        }

        document.getElementById('eventForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const selectedEventOption = document.getElementById('eventName').options[document.getElementById('eventName').selectedIndex];
          const eventNameText = selectedEventOption.text;
          const data = {
            eventNameId: selectedEventOption.value,
            mandal: document.getElementById('mandal').value,
            date: document.getElementById('eventDate').value,
            time: document.getElementById('eventTime').value,
            location: document.getElementById('location').value
          };
          try{
            await addDoc(collection(db,'events'), data);
            
            const eventsQuery = query(collection(db, "events"), where("eventNameId", "==", data.eventNameId));
            const eventsSnap = await getDocs(eventsQuery);
            const doneSet = new Set(eventsSnap.docs.map(d => d.data().mandal));

            const remaining = mandals.filter(m=> !doneSet.has(m));
            const alertText = `‚úÖ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä: *${eventNameText}*\n\n*‡§Æ‡§Ç‡§°‡§≤:* ${data.mandal}\n*‡§∏‡•ç‡§•‡§æ‡§®:* ${data.location}\n\n*‡§∂‡•á‡§∑ ‡§Æ‡§Ç‡§°‡§≤ (${remaining.length}):*\n- ${remaining.join('\n- ')}`;
            await sendTelegramAlert(alertText);

            if(remaining.length === 0){ await sendTelegramAlert(`üéâ *${eventNameText}* ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§≠‡•Ä 21 ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§∏‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à!`); }

            showSummaryPopup({
                "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ": eventNameText,
                ...data
            });
            alert('‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!');
            e.target.reset();
          }catch(err){ alert('Error: '+err.message); }
        });
    </script>
</body>
</html>
