<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #fff9f3;
      color: #222;
      font-family: 'Noto Sans Devanagari', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      background: #fff6ea;
      border-radius: 14px;
      box-shadow: 0 2px 16px #ff980020;
      padding: 18px 10px 18px 10px;
    }
    h1 {
      color: #e65100;
      text-align: center;
      margin-bottom: 12px;
      font-size: 2.1rem;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar .left,
    .top-bar .right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .top-bar select,
    .top-bar button,
    .top-bar input[type="text"] {
      font-size: 1rem;
      padding: 5px 9px;
      border-radius: 5px;
      border: 1.2px solid #ffa726a9;
      background: #fffaf5;
      color: #442300;
    }
    .top-bar button,
    .tab-btn,
    input[type="submit"] {
      background: #ff9800;
      color: #fff;
      font-weight: 600;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .top-bar button:hover,
    .tab-btn.active,
    .tab-btn:hover,
    input[type="submit"]:hover {
      background: #e65100;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin: 10px 0 8px 0;
      justify-content: center;
    }
    .tab-btn {
      padding: 7px 20px;
      border-radius: 8px 8px 0 0;
      border-bottom: 2px solid transparent;
      background: #ffe0b2;
      color: #8d4700;
      font-weight: 600;
      font-size: 1.02rem;
    }
    .tab-btn.active {
      background: #ff9800;
      color: #fff;
      border-bottom: 2px solid #ff9800;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.2rem;
      background: #fff;
      box-shadow: 0 1px 8px #ffa72611;
      font-size: 0.99rem;
    }
    th, td {
      border: 1px solid #ffa72655;
      padding: 6px 7px;
      text-align: left;
    }
    th {
      background: #ffb74d;
      color: #442300;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #fff3e0;
    }
    .action-btn {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 1.11rem;
      margin: 0 1px;
      background: #ff9800;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.18s;
      min-width: 34px;
    }
    .action-btn.delete {
      background: #e53935;
    }
    .action-btn.delete:hover {
      background: #b71c1c;
    }
    .action-btn:hover {
      background: #e65100;
    }
    .report-photos-grid {
      display: grid;
      grid-template-columns: repeat(3, 48px);
      grid-auto-rows: 48px;
      gap: 4px;
      max-width: 148px;
    }
    .report-photos-grid img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 5px;
      border: 1.5px solid #ff9800;
      cursor: zoom-in;
      transition: box-shadow 0.18s;
      background: #fff7e0;
    }
    #imgZoomModal {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.82);
      align-items: center;
      justify-content: center;
    }
    #imgZoomModal img {
      max-width: 95vw;
      max-height: 93vh;
      border-radius: 14px;
      border: 4px solid #fff;
      box-shadow: 0 0 12px #ff980099;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>

    <!-- Filters & Controls -->
    <div class="top-bar">
      <div class="left">
        <label for="filterEvent">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ:</label>
        <select id="filterEvent"><option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option></select>
        <label for="filterMandal">‡§Æ‡§Ç‡§°‡§≤:</label>
        <select id="filterMandal"><option value="">‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤</option></select>
        <span id="pendingMandals" style="color: red;"></span>
      </div>
      <div class="right">
        <input type="text" id="newEventName" placeholder="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ" style="width:120px;">
        <button onclick="addEventName()">‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('reportsTab')">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä</button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content active" id="reportsTab">
      <table>
        <thead>
          <tr>
            <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th>
            <th>‡§Æ‡§Ç‡§°‡§≤</th>
            <th>‡§∏‡•ç‡§•‡§æ‡§®</th>
            <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
            <th>‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
            <th>‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø</th>
            <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
            <th>‡§´‡•ã‡§ü‡•ã</th>
            <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
          </tr>
        </thead>
        <tbody id="reportList"></tbody>
      </table>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imgZoomModal">
    <img id="imgZoomModalImg" src="">
  </div>

  <!-- Firebase & Telegram Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
      authDomain: "mandaleventall.firebaseapp.com",
      projectId: "mandaleventall",
      storageBucket: "mandaleventall.firebasestorage.app",
      messagingSenderId: "900190130114",
      appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
      measurementId: "G-2BBZZNRS88"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
    const TELEGRAM_CHAT_ID = "733804072";
    const previousReportedMandals = new Set();

    async function sendTelegramAlert(message) {
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
        });
      } catch (err) {
        console.error("‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ:", err);
      }
    }

    async function loadReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '';

      const allMandals = ["‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ", "‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ", "‡§ó‡§∞‡•ã‡§†", "‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ", "‡§ñ‡§°‡§º‡§æ‡§µ‡§¶‡§æ", "‡§∂‡§æ‡§Æ‡§ó‡•ù", "‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ", "‡§¨‡§∏‡§æ‡§à", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä", "‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ", "‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ", "‡§¨‡•Å‡§¢‡§æ", "‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä", "‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù", "‡§¶‡§≤‡•ã‡§¶‡§æ", "‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£"];
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;

      let filtered = [];
      const eventNames = await getDocs(collection(db, "eventNames"));

      for (const eventNameDoc of eventNames.docs) {
        const eventNameId = eventNameDoc.id;
        if (filterEventId && eventNameId !== filterEventId) continue;
        const name = eventNameDoc.data().name || '';
        const reports = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        for (const docSnap of reports.docs) {
          const r = docSnap.data();
          if (filterMandalVal && r.mandal !== filterMandalVal) continue;
          filtered.push({ id: docSnap.id, eventNameId, name, ...r });
        }
      }

      const currentMandals = new Set(filtered.map(r => r.mandal));
      const remainingMandals = allMandals.filter(m => !currentMandals.has(m));

      for (const mandal of currentMandals) {
        if (!previousReportedMandals.has(mandal)) {
          previousReportedMandals.add(mandal);
          const msg = `‚úÖ ${mandal} ‡§Æ‡§Ç‡§°‡§≤ ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§à‡•§\nüî¥ ‡§∂‡•á‡§∑ ${remainingMandals.length} ‡§Æ‡§Ç‡§°‡§≤: ${remainingMandals.join(", ")}`;
          sendTelegramAlert(msg);
        }
      }

      for (const r of filtered) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.name}</td>
          <td>${r.mandal || '-'}</td>
          <td>${r.location || '-'}</td>
          <td>${r.date || '-'}</td>
          <td>${r.attendance || '-'}</td>
          <td>${r.guests || '-'}</td>
          <td>${r.details || '-'}</td>
          <td>${Array.isArray(r.photos) ? '<div class="report-photos-grid">' + r.photos.slice(0, 6).map(url => `<img src="${url}" onclick="zoomImage(event, '${url}')">`).join('') + '</div>' : ''}</td>
          <td>...</td>`;
        reportList.appendChild(row);
      }

      document.getElementById('pendingMandals').innerText = remainingMandals.length ? `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç: ${remainingMandals.join(", ")}` : '';
    }

    window.zoomImage = function(e, url) {
      e.preventDefault();
      document.getElementById('imgZoomModalImg').src = url;
      document.getElementById('imgZoomModal').style.display = 'flex';
    };
    document.getElementById('imgZoomModal').onclick = function() {
      this.style.display = 'none';
      document.getElementById('imgZoomModalImg').src = '';
    };

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    async function addEventName() {
      const name = document.getElementById('newEventName').value.trim();
      if (!name) return alert("‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡§ø‡§è!");
      alert("‡§Ø‡§π ‡§´‡•Ä‡§ö‡§∞ ‡§°‡•á‡§Æ‡•ã ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
    }

    document.getElementById('filterEvent').addEventListener('change', loadReports);
    document.getElementById('filterMandal').addEventListener('change', loadReports);

    loadReports();
  </script>
  </script>
</body>
</html>
