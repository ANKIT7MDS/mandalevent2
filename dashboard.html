<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// मंडल लिस्ट
const mandals = ["भेंसोदा", "भानपुरा", "गरोठ", "मेलखेडा", "खड़ावदा", "शामगढ़", "सुवासरा", "बसाई", "सीतामऊ", "क्यामपुर", "सीतामऊ ग्रामीण", "गुर्जर बरडिया", "धुंधधड़का", "बुढा", "पिपलिया मंडी", "मल्हारगढ़", "दलोदा", "मगरामाता जी", "मंदसौर ग्रामीण", "मंदसौर उत्तर", "मंदसौर दक्षिण"];

const eventNameMap = {}; // eventNameId => name

// कार्यक्रम नाम जोड़ना
document.getElementById('eventNameForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const newEventName = document.getElementById('newEventName').value.trim();
    if (!newEventName) return alert('कार्यक्रम नाम लिखिए!');
    await addDoc(collection(db, "eventNames"), { name: newEventName });
    alert('कार्यक्रम नाम जोड़ दिया गया!');
    document.getElementById('newEventName').value = '';
    await loadEventNames(); // लिस्ट अपडेट
    await loadAll();
});

// कार्यक्रम नाम लिस्ट + Edit/Delete
async function loadEventNames() {
    const list = document.getElementById('eventNameList');
    list.innerHTML = '';
    const countEl = document.getElementById('eventNameCount');
    const filterEvent = document.getElementById('filterEvent');
    filterEvent.innerHTML = `<option value="">सभी कार्यक्रम</option>`;
    const snap = await getDocs(collection(db, "eventNames"));
    let count = 0;
    for (const docSnap of snap.docs) {
        const data = docSnap.data();
        eventNameMap[docSnap.id] = data.name || 'Unknown';
        count++;
        // लिस्ट में Add (Edit/Delete ऑप्शन के साथ)
        const li = document.createElement('li');
        li.style.marginBottom = '4px';
        li.innerHTML = `<span id="ename-${docSnap.id}">${data.name}</span>
            <button style="background:#ff9800;" onclick="editEventNamePrompt('${docSnap.id}')">✏️</button>
            <button style="background:#d32f2f;" onclick="deleteEventName('${docSnap.id}')">❌</button>`;
        list.appendChild(li);

        // फ़िल्टर ड्रॉपडाउन में भी Add
        const option = document.createElement('option');
        option.value = docSnap.id;
        option.textContent = data.name;
        filterEvent.appendChild(option);
    }
    countEl.textContent = count;
}
window.editEventNamePrompt = async function(eventNameId) {
    const current = eventNameMap[eventNameId] || '';
    const updated = prompt("नया कार्यक्रम नाम लिखें:", current);
    if (updated && updated.trim() && updated !== current) {
        await updateDoc(doc(db, "eventNames", eventNameId), { name: updated.trim() });
        await loadEventNames();
        await loadAll();
    }
};
window.deleteEventName = async function(eventNameId) {
    if (confirm("इस कार्यक्रम नाम को हटाने से सम्बंधित सभी संयोजक और रिपोर्ट भी हट जायेंगे!\nपक्का?")) {
        await deleteDoc(doc(db, "eventNames", eventNameId));
        await loadEventNames();
        await loadAll();
    }
};

// मंडल फ़िल्टर ड्रॉपडाउन
const filterMandal = document.getElementById('filterMandal');
mandals.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    filterMandal.appendChild(opt);
});

// Filters (onchange)
document.getElementById('filterEvent').addEventListener('change', loadAll);
document.getElementById('filterMandal').addEventListener('change', loadAll);

// Load functions with Filters
async function loadEvents() {
    const eventList = document.getElementById('eventList');
    eventList.innerHTML = '';
    const filterEventId = document.getElementById('filterEvent').value;
    const filterMandalVal = document.getElementById('filterMandal').value;
    const events = await getDocs(collection(db, "events"));
    for (const docSnap of events.docs) {
        const event = docSnap.data();
        // Apply Filters
        if (filterEventId && event.eventNameId !== filterEventId) continue;
        if (filterMandalVal && event.mandal !== filterMandalVal) continue;
        let eventName = eventNameMap[event.eventNameId] || 'Unknown';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${eventName}</td>
            <td>${event.mandal || '-'}</td>
            <td>${event.date || '-'}</td>
            <td>${event.time || '-'}</td>
            <td>${event.location || '-'}</td>
            <td>
                <button onclick="deleteEvent('${docSnap.id}')">Delete</button>
            </td>
        `;
        eventList.appendChild(row);
    }
}
async function loadCoordinators() {
    const coordinatorList = document.getElementById('coordinatorList');
    coordinatorList.innerHTML = '';
    const filterEventId = document.getElementById('filterEvent').value;
    const filterMandalVal = document.getElementById('filterMandal').value;
    const eventNames = await getDocs(collection(db, "eventNames"));
    for (const eventNameDoc of eventNames.docs) {
        if (filterEventId && eventNameDoc.id !== filterEventId) continue;
        const eventName = eventNameDoc.data().name || 'Unknown';
        const coordinators = await getDocs(collection(db, `eventNames/${eventNameDoc.id}/coordinators`));
        for (const coordDoc of coordinators.docs) {
            const coord = coordDoc.data();
            if (filterMandalVal && coord.mandal !== filterMandalVal) continue;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${eventName}</td>
                <td>${coord.mandal || '-'}</td>
                <td>${coord.name || '-'}</td>
                <td>${coord.mobile || '-'}</td>
                <td>${coord.coCoordName1 || '-'}</td>
                <td>${coord.coCoordMobile1 || '-'}</td>
                <td>${coord.coCoordName2 || '-'}</td>
                <td>${coord.coCoordMobile2 || '-'}</td>
                <td>
                    <button onclick="deleteCoordinator('${eventNameDoc.id}','${coordDoc.id}')">Delete</button>
                </td>
            `;
            coordinatorList.appendChild(row);
        }
    }
}
async function loadReports() {
    const reportList = document.getElementById('reportList');
    reportList.innerHTML = '';
    const filterEventId = document.getElementById('filterEvent').value;
    const filterMandalVal = document.getElementById('filterMandal').value;
    const eventNames = await getDocs(collection(db, "eventNames"));
    for (const eventNameDoc of eventNames.docs) {
        if (filterEventId && eventNameDoc.id !== filterEventId) continue;
        const eventName = eventNameDoc.data().name || 'Unknown';
        const reports = await getDocs(collection(db, `eventNames/${eventNameDoc.id}/reports`));
        for (const reportDoc of reports.docs) {
            const report = reportDoc.data();
            if (filterMandalVal && report.mandal !== filterMandalVal) continue;
            const photosHtml = report.photos?.length
                ? report.photos.map(url => `<img src="${url}" alt="फोटो">`).join(' ')
                : '-';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${eventName}</td>
                <td>${report.mandal || '-'}</td>
                <td>${report.location || '-'}</td>
                <td>${report.attendance || '-'}</td>
                <td>${report.guests || '-'}</td>
                <td>${report.details || '-'}</td>
                <td>${photosHtml}</td>
                <td>
                    <button onclick="deleteReport('${eventNameDoc.id}','${reportDoc.id}')">Delete</button>
                </td>
            `;
            reportList.appendChild(row);
        }
    }
}

// Delete Functions
window.deleteEvent = async function (eventId) {
    if (confirm("डिलीट करना है?")) {
        await deleteDoc(doc(db, "events", eventId));
        loadAll();
    }
};
window.deleteCoordinator = async function (eventNameId, coordinatorId) {
    if (confirm("डिलीट करना है?")) {
        await deleteDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordinatorId));
        loadAll();
    }
};
window.deleteReport = async function (eventNameId, reportId) {
    if (confirm("डिलीट करना है?")) {
        await deleteDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId));
        loadAll();
    }
};

// Load All Tables
async function loadAll() {
    await loadEventNames();
    await loadEvents();
    await loadCoordinators();
    await loadReports();
}
document.addEventListener('DOMContentLoaded', loadAll);
</script>
