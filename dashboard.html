<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® + ‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§™‡•á‡§ú PDF)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { background: #fff9f3; color: #222; font-family: 'Noto Sans Devanagari', Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 24px auto; background: #fff6ea; border-radius: 14px; box-shadow: 0 2px 16px #ff980020; padding: 18px 10px 18px 10px; }

    /* ---- Header for PDF ---- */
    #pdfHeader { text-align:center; margin: 6px 0 18px; }
    #pdfHeader h1 { font-size: 2.2rem; margin: 0; color: #000; font-weight: 700; text-decoration: underline; }
    #pdfHeader h2 { font-size: 1.6rem; margin: 6px 0 0; color: #333; font-weight: 600; }

    h1.pageTitle { color: #e65100; text-align: center; margin-bottom: 12px; font-size: 2.1rem; }
    .top-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .top-bar .left, .top-bar .right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .top-bar select, .top-bar button, .top-bar input[type="text"] { font-size: 1rem; padding: 5px 9px; border-radius: 5px; border: 1.2px solid #ffa726a9; background: #fffaf5; color: #442300; }
    .top-bar button, .tab-btn, input[type="submit"], .form-section button { background: #ff9800; color: #fff; font-weight: 600; border: none; cursor: pointer; padding: 7px 14px; border-radius: 6px; margin: 0; transition: background 0.2s; }
    .top-bar button:hover, .tab-btn.active, .tab-btn:hover, input[type="submit"]:hover, .form-section button:hover { background: #e65100; }
    .pending-mandals { color: #e53935; font-size: 0.98rem; margin-left: 18px; }
    .tabs { display: flex; flex-wrap: wrap; gap: 4px; margin: 10px 0 8px 0; justify-content: center; }
    .tab-btn { padding: 7px 20px; border-radius: 8px 8px 0 0; border-bottom: 2px solid transparent; background: #ffe0b2; color: #8d4700; font-weight: 600; font-size: 1.02rem; }
    .tab-btn.active { background: #ff9800; color: #fff; border-bottom: 2px solid #ff9800; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .search-bar { margin: 8px 0 12px 0; text-align: center; }
    .search-bar input { font-size: 1rem; padding: 6px 12px; border-radius: 6px; border: 1.2px solid #ffa726a9; background: #fffaf5; color: #442300; width: 50%; max-width: 400px; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 1.2rem; background: #fff; box-shadow: 0 1px 8px #ffa72611; font-size: 0.99rem; }
    th, td { border: 1px solid #ffa72655; padding: 8px 9px; text-align: left; vertical-align: middle; }
    th { background: #ffb74d; color: #442300; font-weight: bold; }
    tr:nth-child(even) { background: #fff3e0; }

    .action-btn { padding: 4px 10px; border-radius: 6px; font-size: 1.11rem; margin: 0 1px; background: #ff9800; color: #fff; border: none; cursor: pointer; transition: background 0.18s; min-width: 34px; }
    .action-btn.delete { background: #e53935; }
    .action-btn.delete:hover { background: #b71c1c; }
    .action-btn:hover { background: #e65100; }

    .report-photos-grid { display: grid; grid-template-columns: repeat(3, 74px); grid-auto-rows: 74px; gap: 6px; max-width: 200px; }
    .report-photos-grid img { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; border: 1.5px solid #ff9800; cursor: zoom-in; transition: box-shadow 0.18s; background: #fff7e0; }

    #imgZoomModal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.82); align-items: center; justify-content: center; }
    #imgZoomModal img { max-width: 95vw; max-height: 93vh; border-radius: 14px; border: 4px solid #fff; box-shadow: 0 0 12px #ff980099; background: #fff; }

    .form-section { padding: 16px; background: #fffaf5; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; }
    .form-section input[type="text"] { font-size: 1rem; padding: 6px 12px; border-radius: 6px; border: 1.2px solid #ffa726a9; background: #fff; color: #442300; margin-right: 8px; }

    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(26px); }

    .pagination-controls { text-align: center; margin-top: 10px; }
    .pagination-controls button { margin: 0 5px; padding: 5px 10px; }

    @media (max-width: 650px) {
      .container { max-width: 99vw; padding: 4vw 1vw; }
      .top-bar { flex-direction: column; align-items: stretch; gap: 7px; }
      .tabs { flex-direction: column; gap: 1px; }
      .search-bar input { width: 90%; }
      table, th, td { font-size: 0.94rem; padding: 5px; }
      .report-photos-grid { grid-template-columns: repeat(3, 48px); grid-auto-rows: 48px; max-width: 130px; }
      .report-photos-grid img { width: 46px; height: 46px; }
    }
  </style>

  <!-- Export libs -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">

    <!-- ======= PDF Header (Shown in exports) ======= -->
    <div id="pdfHeader">
      <h1>‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</h1>
      <h2 id="eventTitle">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</h2>
    </div>

    <h1 class="pageTitle">‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>

    <div class="top-bar">
      <div class="left">
        <label for="filterEvent">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ:</label>
        <select id="filterEvent"><option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option></select>
        <label for="filterMandal">‡§Æ‡§Ç‡§°‡§≤:</label>
        <select id="filterMandal"><option value="">‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤</option></select>
        <span id="pendingMandals" class="pending-mandals"></span>
      </div>
      <div class="right">
        <select id="exportDropdown" style="min-width:170px">
          <option value="">‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü...</option>
          <optgroup label="‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä">
            <option value="reports-pdf">PDF (‡§´‡•ã‡§ü‡•ã ‡§ï‡•á ‡§∏‡§æ‡§•)</option>
            <option value="reports-excel">Excel</option>
            <option value="reports-jpg">JPG</option>
          </optgroup>
          <optgroup label="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä">
            <option value="events-pdf">PDF</option>
            <option value="events-excel">Excel</option>
            <option value="events-jpg">JPG</option>
          </optgroup>
          <optgroup label="‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä">
            <option value="coordinators-pdf">PDF</option>
            <option value="coordinators-excel">Excel</option>
            <option value="coordinators-jpg">JPG</option>
          </optgroup>
        </select>
        <button onclick="handleExport()">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="reportTabBtn" onclick="switchTab('reportsTab')">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="eventTabBtn" onclick="switchTab('eventsTab')">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="coordinatorTabBtn" onclick="switchTab('coordinatorsTab')">‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="settingsTabBtn" onclick="switchTab('settingsTab')">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</button>
    </div>

    <!-- ===== Settings ===== -->
    <div class="tab-content" id="settingsTab">
      <h2>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
      <div class="form-section">
        <input type="text" id="newEventName" placeholder="‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ" style="width:240px;">
        <button onclick="addEventName()">‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
      </div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="eventSettingsList"></tbody>
      </table>
      <div id="settingsPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Events ===== -->
    <div class="tab-content" id="eventsTab">
      <div class="search-bar"><input type="text" id="eventSearch" onkeyup="loadEvents()" placeholder="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ, ‡§Æ‡§Ç‡§°‡§≤ ‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§∏‡§Æ‡§Ø</th><th>‡§∏‡•ç‡§•‡§æ‡§®</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="eventList"></tbody>
      </table>
      <div id="eventPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Coordinators ===== -->
    <div class="tab-content" id="coordinatorsTab">
      <div class="search-bar"><input type="text" id="coordinatorSearch" onkeyup="loadCoordinators()" placeholder="‡§®‡§æ‡§Æ, ‡§Æ‡§Ç‡§°‡§≤ ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th><th>‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 1</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 1</th><th>‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 2</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 2</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="coordinatorList"></tbody>
      </table>
      <div id="coordPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Reports ===== -->
    <div class="tab-content active" id="reportsTab">
      <div class="search-bar"><input type="text" id="reportSearch" onkeyup="loadReports()" placeholder="‡§Æ‡§Ç‡§°‡§≤, ‡§∏‡•ç‡§•‡§æ‡§®, ‡§Ö‡§§‡§ø‡§•‡§ø ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§∏‡•ç‡§•‡§æ‡§®</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th><th>‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø</th><th>‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§´‡•ã‡§ü‡•ã</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="reportList"></tbody>
      </table>
      <div id="reportPagination" class="pagination-controls"></div>
    </div>

  </div>

  <div id="imgZoomModal"><img id="imgZoomModalImg" src=""></div>

  <!-- ============== Firebase + App JS ============== -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc, updateDoc, getDoc, query, where, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
      authDomain: "mandaleventall.firebaseapp.com",
      projectId: "mandaleventall",
      storageBucket: "mandaleventall.firebasestorage.app",
      messagingSenderId: "900190130114",
      appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
      measurementId: "G-2BBZZNRS88"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mandals = ["‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ", "‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ", "‡§ó‡§∞‡•ã‡§†", "‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ", "‡§ñ‡§°‡§º‡§æ‡§µ‡§¶‡§æ", "‡§∂‡§æ‡§Æ‡§ó‡•ù", "‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ", "‡§¨‡§∏‡§æ‡§à", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä", "‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ", "‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ", "‡§¨‡•Å‡§¢‡§æ", "‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä", "‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù", "‡§¶‡§≤‡•ã‡§¶‡§æ", "‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£"];

    const eventNameMap = {};
    let activeEventIds = new Set();
    let eventPage = 1, coordPage = 1, reportPage = 1, settingsPage = 1;
    const PAGE_SIZE = 15;

    const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
    const TELEGRAM_CHAT_ID = "733804072";
    let lastPendingKey = "";

    async function sendTelegramAlert(message) {
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: "Markdown" })
        });
      } catch (err) { console.error("‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ:", err); }
    }

    async function loadEventNames({ preserveSelection = true } = {}) {
      const filterEvent = document.getElementById('filterEvent');
      const previousValue = preserveSelection ? filterEvent.value : "";

      const allEventsSnap = await getDocs(collection(db, "eventNames"));
      const allEvents = allEventsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      allEvents.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'hi'));

      eventNameMap[""] = 'Unknown';
      activeEventIds.clear();
      allEvents.forEach(event => {
        eventNameMap[event.id] = event.name || 'Unknown';
        if (event.isActive) activeEventIds.add(event.id);
      });

      filterEvent.innerHTML = `<option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option>`;
      allEvents.forEach(event => {
        if (event.isActive) {
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = event.name;
          filterEvent.appendChild(option);
        }
      });

      if (preserveSelection) filterEvent.value = previousValue;

      // Header ‡§Æ‡•á‡§Ç event ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
      const selectedEventId = document.getElementById('filterEvent').value;
      document.getElementById('eventTitle').innerText = selectedEventId ? eventNameMap[selectedEventId] : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";

      await loadEventSettings();
    }

    async function loadEventSettings() {
      const eventSettingsList = document.getElementById('eventSettingsList');
      eventSettingsList.innerHTML = '';
      document.getElementById('settingsPagination').innerHTML = '';
      const snap = await getDocs(collection(db, "eventNames"));
      const sortedDocs = snap.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || '', 'hi'));

      const totalPages = Math.max(1, Math.ceil(sortedDocs.length / PAGE_SIZE));
      settingsPage = Math.min(settingsPage || 1, totalPages);
      const pageEvents = sortedDocs.slice((settingsPage - 1) * PAGE_SIZE, settingsPage * PAGE_SIZE);

      for (const docSnap of pageEvents) {
        const data = docSnap.data();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.name}</td>
          <td>
            <label class="toggle-switch">
              <input type="checkbox" onchange="toggleEventVisibility('${docSnap.id}', this.checked)" ${data.isActive ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td>
            <button class="action-btn" onclick="editEventNamePrompt('${docSnap.id}')" title="‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡•á‡§Ç">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteEventName('${docSnap.id}')" title="‡§π‡§ü‡§æ‡§è‡§Ç">üóëÔ∏è</button>
          </td>
        `;
        eventSettingsList.appendChild(row);
      }
      document.getElementById('settingsPagination').innerHTML = `<button onclick="changeSettingsPage(-1)" ${settingsPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${settingsPage}/${totalPages} <button onclick="changeSettingsPage(1)" ${settingsPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    }

    window.changeSettingsPage = function(diff) { settingsPage = Math.max(1, settingsPage + diff); loadEventSettings(); };

    window.toggleEventVisibility = async function(eventNameId, isVisible) {
      await updateDoc(doc(db, "eventNames", eventNameId), { isActive: isVisible });
      await loadEventNames({ preserveSelection: true });
      await loadListsOnly();
    };

    window.addEventName = async function() {
      const newEventName = document.getElementById('newEventName').value.trim();
      if (!newEventName) return alert('‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡§ø‡§è!');
      await addDoc(collection(db, "eventNames"), { name: newEventName, isActive: true });
      document.getElementById('newEventName').value = '';
      await loadEventNames({ preserveSelection: true });
    };

    window.editEventNamePrompt = async function(eventNameId) {
      const current = eventNameMap[eventNameId] || '';
      const updated = prompt("‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:", current);
      if (updated && updated.trim() && updated !== current) {
        await updateDoc(doc(db, "eventNames", eventNameId), { name: updated.trim() });
        await loadEventNames({ preserveSelection: true });
        await loadListsOnly();
      }
    };

    window.deleteEventName = async function(eventNameId) {
      if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§á‡§∏‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§∏‡§≠‡•Ä ‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï, ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡•Ä!")) return;

      try {
        const batch = writeBatch(db);
        const coordinatorsRef = collection(db, `eventNames/${eventNameId}/coordinators`);
        const reportsRef = collection(db, `eventNames/${eventNameId}/reports`);
        const coordinatorsSnap = await getDocs(coordinatorsRef);
        const reportsSnap = await getDocs(reportsRef);
        coordinatorsSnap.forEach(doc => batch.delete(doc.ref));
        reportsSnap.forEach(doc => batch.delete(doc.ref));

        const eventsQuery = query(collection(db, "events"), where("eventNameId", "==", eventNameId));
        const eventsSnap = await getDocs(eventsQuery);
        eventsSnap.forEach(doc => batch.delete(doc.ref));

        batch.delete(doc(db, "eventNames", eventNameId));
        await batch.commit();

        alert("‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§î‡§∞ ‡§â‡§∏‡§∏‡•á ‡§ú‡•Å‡•ú‡§æ ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§");
        document.getElementById('filterEvent').value = '';
        await loadEventNames({ preserveSelection: false });
        await loadListsOnly();
      } catch (error) {
        console.error("Error deleting event data: ", error);
        alert("‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
      }
    };

    const filterMandal = document.getElementById('filterMandal');
    mandals.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      filterMandal.appendChild(opt);
    });

    document.getElementById('filterEvent').addEventListener('change', function(){
      // Header event title update on selection change
      const selectedEventId = this.value;
      document.getElementById('eventTitle').innerText = selectedEventId ? eventNameMap[selectedEventId] : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";

      eventPage=1;coordPage=1;reportPage=1;loadListsOnly();
    });

    document.getElementById('filterMandal').addEventListener('change', function(){eventPage=1;coordPage=1;reportPage=1;loadListsOnly();});

    window.switchTab = function(tabId) {
      ['eventsTab','coordinatorsTab','reportsTab','settingsTab'].forEach(id => document.getElementById(id).classList.remove('active'));
      ['eventTabBtn','coordinatorTabBtn','reportTabBtn','settingsTabBtn'].forEach(id=>document.getElementById(id).classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.getElementById(tabId.replace('Tab','TabBtn')).classList.add('active');
    };

    window.loadEvents = async function() {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = ''; document.getElementById('eventPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('eventSearch').value.toLowerCase();

      const eventsSnap = await getDocs(collection(db, "events"));
      let filtered = [];
      for (const docSnap of eventsSnap.docs) {
        const event = docSnap.data();
        if (!activeEventIds.has(event.eventNameId)) continue;

        const eventName = eventNameMap[event.eventNameId] || '';
        if (filterEventId && event.eventNameId !== filterEventId) continue;
        if (filterMandalVal && event.mandal !== filterMandalVal) continue;

        const searchableText = `${eventName} ${event.mandal || ''} ${event.location || ''}`.toLowerCase();
        if (searchTerm && !searchableText.includes(searchTerm)) continue;
        filtered.push({id: docSnap.id, ...event, eventName});
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      eventPage = Math.min(eventPage || 1, totalPages);
      const pageEvents = filtered.slice((eventPage - 1) * PAGE_SIZE, eventPage * PAGE_SIZE);

      for (const event of pageEvents) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${event.eventName}</td><td>${event.mandal || '-'}</td><td>${event.date || '-'}</td><td>${event.time || '-'}</td><td>${event.location || '-'}</td><td><button class="action-btn" onclick="editEvent('${event.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteEvent('${event.id}')">üóëÔ∏è</button></td>`;
        eventList.appendChild(row);
      }
      document.getElementById('eventPagination').innerHTML = `<button onclick="changeEventPage(-1)" ${eventPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${eventPage}/${totalPages} <button onclick="changeEventPage(1)" ${eventPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.loadCoordinators = async function() {
      const coordinatorList = document.getElementById('coordinatorList');
      coordinatorList.innerHTML = ''; document.getElementById('coordPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('coordinatorSearch').value.toLowerCase();

      let filtered = [];
      const eventNamesSnap = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNamesSnap.docs) {
        const eventNameId = eventNameDoc.id;
        if (!activeEventIds.has(eventNameId)) continue;
        if (filterEventId && eventNameId !== filterEventId) continue;

        const eventName = eventNameDoc.data().name || '';
        const coordsSnap = await getDocs(collection(db, `eventNames/${eventNameId}/coordinators`));
        for (const docSnap of coordsSnap.docs) {
          const c = docSnap.data();
          if (filterMandalVal && c.mandal !== filterMandalVal) continue;
          const searchableText = `${eventName} ${c.mandal || ''} ${c.name || ''} ${c.mobile || ''} ${c.coCoordName1 || ''} ${c.coCoordMobile1 || ''} ${c.coCoordName2 || ''} ${c.coCoordMobile2 || ''}`.toLowerCase();
          if (searchTerm && !searchableText.includes(searchTerm)) continue;
          filtered.push({id: docSnap.id, eventNameId, eventName, ...c});
        }
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      coordPage = Math.min(coordPage || 1, totalPages);
      const pageCoords = filtered.slice((coordPage - 1) * PAGE_SIZE, coordPage * PAGE_SIZE);

      for (const c of pageCoords) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${c.eventName}</td><td>${c.mandal || '-'}</td><td>${c.name || '-'}</td><td>${c.mobile || '-'}</td><td>${c.coCoordName1 || '-'}</td><td>${c.coCoordMobile1 || '-'}</td><td>${c.coCoordName2 || '-'}</td><td>${c.coCoordMobile2 || '-'}</td><td><button class="action-btn" onclick="editCoordinator('${c.eventNameId}','${c.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteCoordinator('${c.eventNameId}','${c.id}')">üóëÔ∏è</button></td>`;
        coordinatorList.appendChild(row);
      }
      document.getElementById('coordPagination').innerHTML = `<button onclick="changeCoordPage(-1)" ${coordPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${coordPage}/${totalPages} <button onclick="changeCoordPage(1)" ${coordPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.loadReports = async function() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = ''; document.getElementById('reportPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('reportSearch').value.toLowerCase();

      let allReports = [];
      const eventNamesSnap = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNamesSnap.docs) {
        const eventNameId = eventNameDoc.id;
        if (!activeEventIds.has(eventNameId)) continue;

        const eventName = eventNameDoc.data().name || '';
        const reportsSnap = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        for (const docSnap of reportsSnap.docs) {
          allReports.push({id: docSnap.id, eventNameId, name: eventName, ...docSnap.data()});
        }
      }

      let filtered = allReports.filter(r => {
        if (filterEventId && r.eventNameId !== filterEventId) return false;
        if (filterMandalVal && r.mandal !== filterMandalVal) return false;
        const searchableText = `${r.name} ${r.mandal || ''} ${r.location || ''} ${r.guests || ''} ${r.details || ''}`.toLowerCase();
        if (searchTerm && !searchableText.includes(searchTerm)) return false;
        return true;
      });

      const reportedMandals = new Set(allReports.filter(r => filterEventId ? r.eventNameId === filterEventId : true).map(r => r.mandal));
      let pendingMandals = mandals.filter(m => !reportedMandals.has(m));
      const pendingText = pendingMandals.length ? `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç: ${pendingMandals.join(", ")}` : '‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§∏‡•á ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡•§';
      document.getElementById('pendingMandals').innerText = (filterEventId && pendingMandals.length) ? pendingText : '';

      const currentKey = `${filterEventId}-${pendingMandals.join("|")}`;
      if (filterEventId && currentKey !== lastPendingKey) {
        lastPendingKey = currentKey;
        await sendTelegramAlert(
          pendingMandals.length
            ? `üîî *${eventNameMap[filterEventId]}*: ${pendingMandals.length} ‡§Æ‡§Ç‡§°‡§≤ ‡§∂‡•á‡§∑ - ${pendingMandals.join(", ")}`
            : `‚úÖ *${eventNameMap[filterEventId]}*: ‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡•§`
        );
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      reportPage = Math.min(reportPage || 1, totalPages);
      const pageReports = filtered.slice((reportPage - 1) * PAGE_SIZE, reportPage * PAGE_SIZE);

      for (const r of pageReports) {
        let photosHTML = "";
        if (Array.isArray(r.photos) && r.photos.length > 0) {
          photosHTML = `<div class="report-photos-grid">${r.photos.slice(0,6).map(url => `<img src="${url}" onclick="zoomImage(event, '${url}')">`).join('')}</div>`;
        }
        const row = document.createElement('tr');
        row.innerHTML = `<td>${r.name}</td><td>${r.mandal || '-'}</td><td>${r.location || '-'}</td><td>${r.date || '-'}</td><td>${r.attendance || '-'}</td><td>${r.guests || '-'}</td><td>${r.details || '-'}</td><td>${photosHTML}</td><td><button class="action-btn" onclick="editReport('${r.eventNameId}','${r.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteReport('${r.eventNameId}','${r.id}')">üóëÔ∏è</button></td>`;
        reportList.appendChild(row);
      }
      document.getElementById('reportPagination').innerHTML = `<button onclick="changeReportPage(-1)" ${reportPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${reportPage}/${totalPages} <button onclick="changeReportPage(1)" ${reportPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.changeEventPage = function(diff) { eventPage = Math.max(1, eventPage + diff); loadEvents(); };
    window.changeCoordPage = function(diff) { coordPage = Math.max(1, coordPage + diff); loadCoordinators(); };
    window.changeReportPage = function(diff) { reportPage = Math.max(1, reportPage + diff); loadReports(); };

    window.editEvent = async function(id) {
      const docSnap = await getDoc(doc(db, "events", id));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const event = docSnap.data();
      const newMandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", event.mandal || ""); if (newMandal === null) return;
      const newDate = prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:", event.date || ""); if (newDate === null) return;
      const newTime = prompt("‡§∏‡§Æ‡§Ø:", event.time || ""); if (newTime === null) return;
      const newLocation = prompt("‡§∏‡•ç‡§•‡§æ‡§®:", event.location || ""); if (newLocation === null) return;
      await updateDoc(doc(db, "events", id), { mandal: newMandal, date: newDate, time: newTime, location: newLocation });
      await loadEvents();
    };
    window.deleteEvent = async function(id) { if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) { await deleteDoc(doc(db, "events", id)); await loadEvents(); } };

    window.editCoordinator = async function(eventNameId, coordId) {
      const docSnap = await getDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const c = docSnap.data();
      const mandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", c.mandal || ""); if (mandal === null) return;
      const name = prompt("‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï:", c.name || ""); if (name === null) return;
      const mobile = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:", c.mobile || ""); if (mobile === null) return;
      const coCoordName1 = prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 1:", c.coCoordName1 || ""); if (coCoordName1 === null) return;
      const coCoordMobile1 = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 1:", c.coCoordMobile1 || ""); if (coCoordMobile1 === null) return;
      const coCoordName2 = prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 2:", c.coCoordName2 || ""); if (coCoordName2 === null) return;
      const coCoordMobile2 = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 2:", c.coCoordMobile2 || ""); if (coCoordMobile2 === null) return;
      await updateDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId), { mandal, name, mobile, coCoordName1, coCoordMobile1, coCoordName2, coCoordMobile2 });
      await loadCoordinators();
    };
    window.deleteCoordinator = async function(eventNameId, coordId) { if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) { await deleteDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId)); await loadCoordinators(); } };

    window.editReport = async function(eventNameId, reportId) {
      const docSnap = await getDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const r = docSnap.data();
      const mandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", r.mandal || ""); if (mandal === null) return;
      const location = prompt("‡§∏‡•ç‡§•‡§æ‡§®:", r.location || ""); if (location === null) return;
      const date = prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:", r.date || ""); if (date === null) return;
      const attendance = prompt("‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø:", r.attendance || ""); if (attendance === null) return;
      const guests = prompt("‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø:", r.guests || ""); if (guests === null) return;
      const details = prompt("‡§µ‡§ø‡§µ‡§∞‡§£:", r.details || ""); if (details === null) return;
      await updateDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId), { mandal, location, date, attendance, guests, details });
      await loadReports();
    };
    window.deleteReport = async function(eventNameId, reportId) { if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) { await deleteDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId)); await loadReports(); } };

    window.zoomImage = function(e, url) { e.preventDefault(); document.getElementById('imgZoomModalImg').src = url; document.getElementById('imgZoomModal').style.display = 'flex'; };
    document.getElementById('imgZoomModal').onclick = function() { this.style.display = 'none'; document.getElementById('imgZoomModalImg').src = ''; };

    async function loadListsOnly() { await Promise.all([loadEvents(), loadCoordinators(), loadReports()]); }
    async function loadAll() { await loadEventNames(); await loadListsOnly(); }
    loadAll();
  </script>

  <!-- ============== Export Helpers (Multi-page PDF) ============== -->
  <script>
    function exportTableToExcel(table, title) {
      if (!table) return alert("‡§è‡§ï‡•ç‡§∏‡•á‡§≤ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§∞‡§£‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!");
      const rows = Array.from(table.querySelectorAll('tr'));
      let data;
      if (title.includes("‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü")) {
        data = rows.map(row =>
          Array.from(row.querySelectorAll("th, td"))
            .filter(cell => !cell.querySelector('div.report-photos-grid'))
            .map(cell => cell.innerText)
        );
      } else {
        data = rows.map(row =>
          Array.from(row.querySelectorAll("th:not(:last-child), td:not(:last-child)"))
            .map(cell => cell.innerText)
        );
      }
      if (data.length < 2) return alert("‡§è‡§ï‡•ç‡§∏‡•á‡§≤ ‡§Æ‡•á‡§Ç ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, title);
      XLSX.writeFile(wb, `${title}.xlsx`);
    }

    async function captureElementWithImages(selector) {
      const element = document.querySelector(selector);
      if (!element) throw new Error("‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");

      const pagination = element.querySelector('.pagination-controls');
      const actionButtons = element.querySelectorAll('.action-btn');
      if (pagination) pagination.style.display = 'none';
      actionButtons.forEach(btn => btn.style.display = 'none');

      // Convert external images to data URLs to avoid CORS in canvas
      const images = Array.from(element.querySelectorAll('img'));
      const originalSrcs = images.map(img => img.src);
      const dataUrlPromises = images.map(async (img) => {
        if (!img.src) return;
        try {
          const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(img.src)}`;
          const response = await fetch(proxyUrl);
          const blob = await response.blob();
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => { img.src = reader.result; resolve(); };
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.warn(`Could not convert image to data URL: ${img.src}`, error);
          return Promise.resolve();
        }
      });
      await Promise.all(dataUrlPromises);

      try {
        // capture FULL height element (not just viewport)
        const canvas = await html2canvas(element, { useCORS: true, scale: 2, backgroundColor: "#fff" });
        return canvas;
      } finally {
        if (pagination) pagination.style.display = 'block';
        actionButtons.forEach(btn => btn.style.display = 'inline-block');
        images.forEach((img, index) => { img.src = originalSrcs[index]; });
      }
    }

    // ---- MULTI-PAGE PDF exporter ----
    function exportCanvasToPdfMultiPage(canvas, fileName) {
      const { jsPDF } = window.jspdf;
      const margin = 20; // pt
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Scale ratio to fit width
      const ratio = (pageW - margin * 2) / canvas.width;
      const sliceHeightPx = (pageH - margin * 2) / ratio; // how many canvas pixels fit on one PDF page

      const ctx = canvas.getContext('2d');
      let yPx = 0;
      let pageIndex = 0;

      while (yPx < canvas.height) {
        const sliceCanvas = document.createElement('canvas');
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = Math.min(sliceHeightPx, canvas.height - yPx);

        const sliceCtx = sliceCanvas.getContext('2d');
        // draw portion of original canvas into slice
        sliceCtx.drawImage(canvas, 0, -yPx);

        const imgData = sliceCanvas.toDataURL('image/jpeg', 0.95);
        if (pageIndex > 0) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', margin, margin, pageW - margin * 2, sliceCanvas.height * ratio);
        yPx += sliceHeightPx;
        pageIndex++;
      }
      pdf.save(`${fileName}.pdf`);
    }

    function exportCanvasToJpg(canvas, fileName) {
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/jpeg", 0.9);
      link.download = `${fileName}.jpg`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.handleExport = async function() {
      try {
        const value = document.getElementById('exportDropdown').value;
        if (!value) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!");
        const [category, type] = value.split('-');

        // Export area = ‡§™‡•Ç‡§∞‡§æ container (‡§§‡§æ‡§ï‡§ø header ‡§≠‡•Ä ‡§Ü‡§è)
        let selector = `.container`;
        let fileName = "";
        let table;

        if (category === 'events') { fileName = "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ-‡§∏‡•Ç‡§ö‡•Ä"; table = document.querySelector('#eventsTab table'); }
        else if (category === 'coordinators') { fileName = "‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï-‡§∏‡•Ç‡§ö‡•Ä"; table = document.querySelector('#coordinatorsTab table'); }
        else if (category === 'reports') { fileName = "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü-‡§∏‡•Ç‡§ö‡•Ä"; table = document.querySelector('#reportsTab table'); }
        else { alert("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡•§"); return; }

        // Export ‡§∏‡•á ‡§†‡•Ä‡§ï ‡§™‡§π‡§≤‡•á header ‡§Æ‡•á‡§Ç ‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è event ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡•á‡§ü/‡§∞‡•Ä‡§´‡§º‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
        const selectedEventId = document.getElementById('filterEvent').value;
        const evTitle = selectedEventId ? (window.eventNameMap ? eventNameMap[selectedEventId] : "‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ") : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
        document.getElementById('eventTitle').innerText = evTitle || "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";

        alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...");

        if (type === 'excel') {
          exportTableToExcel(table, fileName);
        } else {
          captureElementWithImages(selector)
            .then(canvas => {
              if (type === 'pdf') {
                // multi-page
                exportCanvasToPdfMultiPage(canvas, fileName);
              } else if (type === 'jpg') {
                exportCanvasToJpg(canvas, fileName);
              }
            })
            .catch(err => {
              console.error("‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err);
              alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            });
        }
      } catch (error) {
        console.error("‡§´‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
        alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
      }
    };
  </script>
</body>
</html>
