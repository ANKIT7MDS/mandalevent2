<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (‡§´‡•ã‡§ü‡•ã-‡§∏‡§π‡§ø‡§§ ‡§§‡•á‡§ú‡§º ‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§™‡•á‡§ú PDF)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:;base64,=">
  <style>
    body { background:#fff9f3; color:#222; font-family:'Noto Sans Devanagari',Arial,sans-serif; margin:0; padding:0; }
    .container { max-width:1200px; margin:24px auto; background:#fff6ea; border-radius:14px; box-shadow:0 2px 16px #ff980020; padding:18px 10px; }

    #pdfHeader{ text-align:center; margin:6px 0 18px; }
    #pdfHeader h1{ font-size:2.2rem; margin:0; color:#000; font-weight:700; text-decoration:underline;}
    #pdfHeader h2{ font-size:1.6rem; margin:6px 0 0; color:#333; font-weight:600;}

    h1.pageTitle{ color:#e65100; text-align:center; margin-bottom:12px; font-size:2.1rem;}
    .top-bar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .top-bar .left,.top-bar .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .top-bar select,.top-bar button,.top-bar input[type="text"]{ font-size:1rem; padding:5px 9px; border-radius:5px; border:1.2px solid #ffa726a9; background:#fffaf5; color:#442300;}
    .top-bar button,.tab-btn,input[type="submit"],.form-section button{ background:#ff9800; color:#fff; font-weight:600; border:none; cursor:pointer; padding:7px 14px; border-radius:6px; margin:0; transition:background .2s;}
    .top-bar button:hover,.tab-btn.active,.tab-btn:hover,input[type="submit"]:hover,.form-section button:hover{ background:#e65100;}
    .pending-mandals{ color:#e53935; font-size:.98rem; margin-left:18px;}
    .tabs{ display:flex; flex-wrap:wrap; gap:4px; margin:10px 0 8px; justify-content:center;}
    .tab-btn{ padding:7px 20px; border-radius:8px 8px 0 0; border-bottom:2px solid transparent; background:#ffe0b2; color:#8d4700; font-weight:600; font-size:1.02rem;}
    .tab-btn.active{ background:#ff9800; color:#fff; border-bottom:2px solid #ff9800;}
    .tab-content{ display:none;}
    .tab-content.active{ display:block;}
    .search-bar{ margin:8px 0 12px; text-align:center;}
    .search-bar input{ font-size:1rem; padding:6px 12px; border-radius:6px; border:1.2px solid #ffa726a9; background:#fffaf5; color:#442300; width:50%; max-width:400px;}

    table{ width:100%; border-collapse:collapse; margin-bottom:1.2rem; background:#fff; box-shadow:0 1px 8px #ffa72611; font-size:.99rem;}
    th,td{ border:1px solid #ffa72655; padding:8px 9px; text-align:left; vertical-align:middle;}
    th{ background:#ffb74d; color:#442300; font-weight:bold;}
    tr:nth-child(even){ background:#fff3e0;}

    .action-btn{ padding:4px 10px; border-radius:6px; font-size:1.11rem; margin:0 1px; background:#ff9800; color:#fff; border:none; cursor:pointer; transition:background .18s; min-width:34px;}
    .action-btn.delete{ background:#e53935;}
    .action-btn.delete:hover{ background:#b71c1c;}
    .action-btn:hover{ background:#e65100;}

    .report-photos-grid{ display:grid; grid-template-columns:repeat(3,74px); grid-auto-rows:74px; gap:6px; max-width:220px;}
    .report-photos-grid img{ width:72px; height:72px; object-fit:cover; border-radius:6px; border:1.5px solid #ff9800; cursor:zoom-in; background:#fff7e0;}

    #imgZoomModal{ display:none; position:fixed; z-index:2000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,.82); align-items:center; justify-content:center;}
    #imgZoomModal img{ max-width:95vw; max-height:93vh; border-radius:14px; border:4px solid #fff; box-shadow:0 0 12px #ff980099; background:#fff;}

    .form-section{ padding:16px; background:#fffaf5; border-radius:8px; margin-bottom:20px; border:1px solid #ffe0b2;}
    .form-section input[type="text"]{ font-size:1rem; padding:6px 12px; border-radius:6px; border:1.2px solid #ffa726a9; background:#fff; color:#442300; margin-right:8px;}

    .toggle-switch{ position:relative; display:inline-block; width:50px; height:24px;}
    .toggle-switch input{ opacity:0; width:0; height:0;}
    .slider{ position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px;}
    .slider:before{ position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%;}
    input:checked + .slider{ background-color:#4CAF50;}
    input:checked + .slider:before{ transform:translateX(26px);}

    .pagination-controls{ text-align:center; margin-top:10px;}
    .pagination-controls button{ margin:0 5px; padding:5px 10px;}

    /* HIDDEN EXPORT DOC (REPORTS) */
    #exportDocRoot{ position:fixed; left:-99999px; top:-99999px; width:1100px; background:#fff; padding:16px;}
    #exportDocRoot .header{ text-align:center; margin-bottom:12px;}
    #exportDocRoot h1{ font-size:28px; margin:0; font-weight:700; text-decoration:underline;}
    #exportDocRoot h2{ font-size:22px; margin:6px 0 0; font-weight:600;}
    #exportDocRoot table{ width:100%; border-collapse:collapse; font-size:13px;}
    #exportDocRoot th,#exportDocRoot td{ border:1px solid #ccc; padding:6px; vertical-align:top;}
    #exportDocRoot th{ background:#f4f4f4;}
    #exportDocRoot .photos{ display:grid; grid-template-columns:repeat(5,64px); grid-auto-rows:64px; gap:4px;}
    #exportDocRoot .photos img{ width:62px; height:62px; object-fit:cover; border:1px solid #ddd; border-radius:4px;}
    @media print{ #exportDocRoot{ position:static; width:auto; } }

    @media (max-width:650px){
      .container{ max-width:99vw; padding:4vw 1vw;}
      .top-bar{ flex-direction:column; align-items:stretch; gap:7px;}
      .tabs{ flex-direction:column; gap:1px;}
      .search-bar input{ width:90%;}
      table,th,td{ font-size:.94rem; padding:5px;}
      .report-photos-grid{ grid-template-columns:repeat(3,48px); grid-auto-rows:48px; max-width:130px;}
      .report-photos-grid img{ width:46px; height:46px;}
    }
  </style>

  <!-- Export libs -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="pdfHeader">
      <h1>‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</h1>
      <h2 id="eventTitle">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</h2>
    </div>

    <h1 class="pageTitle">‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>

    <div class="top-bar">
      <div class="left">
        <label for="filterEvent">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ:</label>
        <select id="filterEvent"><option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option></select>
        <label for="filterMandal">‡§Æ‡§Ç‡§°‡§≤:</label>
        <select id="filterMandal"><option value="">‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤</option></select>
        <span id="pendingMandals" class="pending-mandals"></span>
      </div>
      <div class="right">
        <select id="exportDropdown" style="min-width:220px">
          <option value="">‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü...</option>
          <optgroup label="‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä (‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•Ä ‡§™‡•Ç‡§∞‡•Ä)">
            <option value="reports-pdf">PDF (‡§´‡•ã‡§ü‡•ã ‡§∏‡§π‡§ø‡§§)</option>
            <option value="reports-excel">Excel</option>
            <option value="reports-jpg">JPG</option>
          </optgroup>
          <optgroup label="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä (‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ú‡•à‡§∏‡§æ)">
            <option value="events-pdf">PDF</option>
            <option value="events-excel">Excel</option>
            <option value="events-jpg">JPG</option>
          </optgroup>
          <optgroup label="‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä (‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§ú‡•à‡§∏‡§æ)">
            <option value="coordinators-pdf">PDF</option>
            <option value="coordinators-excel">Excel</option>
            <option value="coordinators-jpg">JPG</option>
          </optgroup>
        </select>
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:6px;">
          <input type="checkbox" id="fastMode" checked> ‡§§‡•á‡§ú‡§º ‡§Æ‡•ã‡§°
        </label>
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:6px;">
          <input type="checkbox" id="landscapeMode" checked> PDF ‡§≤‡•à‡§Ç‡§°‡§∏‡•ç‡§ï‡•á‡§™
        </label>
        <button onclick="handleExport()">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="reportTabBtn" onclick="switchTab('reportsTab')">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="eventTabBtn" onclick="switchTab('eventsTab')">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="coordinatorTabBtn" onclick="switchTab('coordinatorsTab')">‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä</button>
      <button class="tab-btn" id="settingsTabBtn" onclick="switchTab('settingsTab')">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</button>
    </div>

    <!-- ===== Settings ===== -->
    <div class="tab-content" id="settingsTab">
      <h2>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h2>
      <div class="form-section">
        <input type="text" id="newEventName" placeholder="‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ" style="width:240px;">
        <button onclick="addEventName()">‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
      </div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th><th>‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="eventSettingsList"></tbody>
      </table>
      <div id="settingsPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Events ===== -->
    <div class="tab-content" id="eventsTab">
      <div class="search-bar"><input type="text" id="eventSearch" onkeyup="loadEvents()" placeholder="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ, ‡§Æ‡§Ç‡§°‡§≤ ‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§∏‡§Æ‡§Ø</th><th>‡§∏‡•ç‡§•‡§æ‡§®</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="eventList"></tbody>
      </table>
      <div id="eventPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Coordinators ===== -->
    <div class="tab-content" id="coordinatorsTab">
      <div class="search-bar"><input type="text" id="coordinatorSearch" onkeyup="loadCoordinators()" placeholder="‡§®‡§æ‡§Æ, ‡§Æ‡§Ç‡§°‡§≤ ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th><th>‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 1</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 1</th><th>‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 2</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 2</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="coordinatorList"></tbody>
      </table>
      <div id="coordPagination" class="pagination-controls"></div>
    </div>

    <!-- ===== Reports (UI) ===== -->
    <div class="tab-content active" id="reportsTab">
      <div class="search-bar"><input type="text" id="reportSearch" onkeyup="loadReports()" placeholder="‡§Æ‡§Ç‡§°‡§≤, ‡§∏‡•ç‡§•‡§æ‡§®, ‡§Ö‡§§‡§ø‡§•‡§ø ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
      <table>
        <thead><tr><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th><th>‡§Æ‡§Ç‡§°‡§≤</th><th>‡§∏‡•ç‡§•‡§æ‡§®</th><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th><th>‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø</th><th>‡§µ‡§ø‡§µ‡§∞‡§£</th><th>‡§´‡•ã‡§ü‡•ã</th><th>‡§è‡§ï‡•ç‡§∂‡§®</th></tr></thead>
        <tbody id="reportList"></tbody>
      </table>
      <div id="reportPagination" class="pagination-controls"></div>
    </div>
  </div>

  <!-- HIDDEN EXPORT ROOT -->
  <div id="exportDocRoot" style="display:none;"></div>

  <div id="imgZoomModal"><img id="imgZoomModalImg" src=""></div>

  <!-- ============== Firebase + App JS ============== -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc, updateDoc, getDoc, query, where, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
      authDomain: "mandaleventall.firebaseapp.com",
      projectId: "mandaleventall",
      storageBucket: "mandaleventall.firebasestorage.app",
      messagingSenderId: "900190130114",
      appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
      measurementId: "G-2BBZZNRS88"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mandals = ["‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ","‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ","‡§ó‡§∞‡•ã‡§†","‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ","‡§ñ‡§°‡§º‡§æ‡§µ‡§¶‡§æ","‡§∂‡§æ‡§Æ‡§ó‡•ù","‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ","‡§¨‡§∏‡§æ‡§à","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä","‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞","‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ","‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ","‡§¨‡•Å‡§¢‡§æ","‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä","‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù","‡§¶‡§≤‡•ã‡§¶‡§æ","‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞","‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£"];

    const eventNameMap = {};
    let activeEventIds = new Set();
    let eventPage = 1, coordPage = 1, reportPage = 1, settingsPage = 1;
    const PAGE_SIZE = 15;

    const TELEGRAM_BOT_TOKEN = "8064306737:AAFvXvc3vIT1kyccGiPbpYGCAr9dgKJcRzw";
    const TELEGRAM_CHAT_ID = "733804072";
    let lastPendingKey = "";

    async function sendTelegramAlert(message) {
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: "Markdown" })
        });
      } catch (err) { console.error("‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ:", err); }
    }

    async function loadEventNames({ preserveSelection = true } = {}) {
      const filterEvent = document.getElementById('filterEvent');
      const previousValue = preserveSelection ? filterEvent.value : "";

      const allEventsSnap = await getDocs(collection(db, "eventNames"));
      const allEvents = allEventsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      allEvents.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'hi'));

      eventNameMap[""] = 'Unknown';
      activeEventIds.clear();
      filterEvent.innerHTML = `<option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option>`;

      allEvents.forEach(event => {
        eventNameMap[event.id] = event.name || 'Unknown';
        if (event.isActive) {
          activeEventIds.add(event.id);
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = event.name;
          filterEvent.appendChild(option);
        }
      });

      if (preserveSelection) filterEvent.value = previousValue;

      const sel = document.getElementById('filterEvent');
      const txt = sel.options[sel.selectedIndex]?.text?.trim() || "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
      document.getElementById('eventTitle').innerText = sel.value ? txt : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";

      await loadEventSettings();
    }

    async function loadEventSettings() {
      const eventSettingsList = document.getElementById('eventSettingsList');
      eventSettingsList.innerHTML = '';
      document.getElementById('settingsPagination').innerHTML = '';
      const snap = await getDocs(collection(db, "eventNames"));
      const sortedDocs = snap.docs.sort((a, b) => (a.data().name || '').localeCompare(b.data().name || '', 'hi'));

      const totalPages = Math.max(1, Math.ceil(sortedDocs.length / PAGE_SIZE));
      settingsPage = Math.min(settingsPage || 1, totalPages);
      const pageEvents = sortedDocs.slice((settingsPage - 1) * PAGE_SIZE, settingsPage * PAGE_SIZE);

      for (const docSnap of pageEvents) {
        const data = docSnap.data();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.name}</td>
          <td>
            <label class="toggle-switch">
              <input type="checkbox" onchange="toggleEventVisibility('${docSnap.id}', this.checked)" ${data.isActive ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td>
            <button class="action-btn" onclick="editEventNamePrompt('${docSnap.id}')" title="‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡•á‡§Ç">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteEventName('${docSnap.id}')" title="‡§π‡§ü‡§æ‡§è‡§Ç">üóëÔ∏è</button>
          </td>
        `;
        eventSettingsList.appendChild(row);
      }
      document.getElementById('settingsPagination').innerHTML = `<button onclick="changeSettingsPage(-1)" ${settingsPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${settingsPage}/${totalPages} <button onclick="changeSettingsPage(1)" ${settingsPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    }

    window.changeSettingsPage = function(diff) { settingsPage = Math.max(1, settingsPage + diff); loadEventSettings(); };

    window.toggleEventVisibility = async function(eventNameId, isVisible) {
      await updateDoc(doc(db, "eventNames", eventNameId), { isActive: isVisible });
      await loadEventNames({ preserveSelection: true });
      await loadListsOnly();
    };

    window.addEventName = async function() {
      const newEventName = document.getElementById('newEventName').value.trim();
      if (!newEventName) return alert('‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡§ø‡§è!');
      await addDoc(collection(db, "eventNames"), { name: newEventName, isActive: true });
      document.getElementById('newEventName').value = '';
      await loadEventNames({ preserveSelection: true });
    };

    window.editEventNamePrompt = async function(eventNameId) {
      const current = eventNameMap[eventNameId] || '';
      const updated = prompt("‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:", current);
      if (updated && updated.trim() && updated !== current) {
        await updateDoc(doc(db, "eventNames", eventNameId), { name: updated.trim() });
        await loadEventNames({ preserveSelection: true });
        await loadListsOnly();
      }
    };

    window.deleteEventName = async function(eventNameId) {
      if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§á‡§∏‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§∏‡§≠‡•Ä ‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï, ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡•Ä!")) return;

      try {
        const batch = writeBatch(db);
        const coordinatorsRef = collection(db, `eventNames/${eventNameId}/coordinators`);
        const reportsRef = collection(db, `eventNames/${eventNameId}/reports`);
        const coordinatorsSnap = await getDocs(coordinatorsRef);
        const reportsSnap = await getDocs(reportsRef);
        coordinatorsSnap.forEach(doc => batch.delete(doc.ref));
        reportsSnap.forEach(doc => batch.delete(doc.ref));

        const eventsQuery = query(collection(db, "events"), where("eventNameId", "==", eventNameId));
        const eventsSnap = await getDocs(eventsQuery);
        eventsSnap.forEach(doc => batch.delete(doc.ref));

        batch.delete(doc(db, "eventNames", eventNameId));
        await batch.commit();

        alert("‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§î‡§∞ ‡§â‡§∏‡§∏‡•á ‡§ú‡•Å‡•ú‡§æ ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§");
        document.getElementById('filterEvent').value = '';
        await loadEventNames({ preserveSelection: false });
        await loadListsOnly();
      } catch (error) {
        console.error("Error deleting event data: ", error);
        alert("‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
      }
    };

    const filterMandal = document.getElementById('filterMandal');
    mandals.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      filterMandal.appendChild(opt);
    });

    document.getElementById('filterEvent').addEventListener('change', function () {
      const txt = this.options[this.selectedIndex]?.text?.trim() || "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
      document.getElementById('eventTitle').innerText = this.value ? txt : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
      eventPage = 1; coordPage = 1; reportPage = 1; loadListsOnly();
    });

    document.getElementById('filterMandal').addEventListener('change', function(){eventPage=1;coordPage=1;reportPage=1;loadListsOnly();});

    window.switchTab = function(tabId) {
      ['eventsTab','coordinatorsTab','reportsTab','settingsTab'].forEach(id => document.getElementById(id).classList.remove('active'));
      ['eventTabBtn','coordinatorTabBtn','reportTabBtn','settingsTabBtn'].forEach(id=>document.getElementById(id).classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.getElementById(tabId.replace('Tab','TabBtn')).classList.add('active');
    };

    /* ===== UI Lists ===== */
    window.loadEvents = async function() {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = ''; document.getElementById('eventPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';

      const eventsSnap = await getDocs(collection(db, "events"));
      let filtered = [];
      for (const docSnap of eventsSnap.docs) {
        const event = docSnap.data();
        if (!activeEventIds.has(event.eventNameId)) continue;

        const eventName = eventNameMap[event.eventNameId] || '';
        if (filterEventId && event.eventNameId !== filterEventId) continue;
        if (filterMandalVal && event.mandal !== filterMandalVal) continue;

        const searchableText = `${eventName} ${event.mandal || ''} ${event.location || ''}`.toLowerCase();
        if (searchTerm && !searchableText.includes(searchTerm)) continue;
        filtered.push({id: docSnap.id, ...event, eventName});
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      eventPage = Math.min(eventPage || 1, totalPages);
      const pageEvents = filtered.slice((eventPage - 1) * PAGE_SIZE, eventPage * PAGE_SIZE);

      for (const event of pageEvents) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${event.eventName}</td><td>${event.mandal || '-'}</td><td>${event.date || '-'}</td><td>${event.time || '-'}</td><td>${event.location || '-'}</td><td><button class="action-btn" onclick="editEvent('${event.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteEvent('${event.id}')">üóëÔ∏è</button></td>`;
        eventList.appendChild(row);
      }
      document.getElementById('eventPagination').innerHTML = `<button onclick="changeEventPage(-1)" ${eventPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${eventPage}/${totalPages} <button onclick="changeEventPage(1)" ${eventPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.loadCoordinators = async function() {
      const coordinatorList = document.getElementById('coordinatorList');
      coordinatorList.innerHTML = ''; document.getElementById('coordPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('coordinatorSearch')?.value.toLowerCase() || '';

      let filtered = [];
      const eventNamesSnap = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNamesSnap.docs) {
        const eventNameId = eventNameDoc.id;
        if (!activeEventIds.has(eventNameId)) continue;
        if (filterEventId && eventNameId !== filterEventId) continue;

        const eventName = eventNameDoc.data().name || '';
        const coordsSnap = await getDocs(collection(db, `eventNames/${eventNameId}/coordinators`));
        for (const docSnap of coordsSnap.docs) {
          const c = docSnap.data();
          if (filterMandalVal && c.mandal !== filterMandalVal) continue;
          const searchableText = `${eventName} ${c.mandal || ''} ${c.name || ''} ${c.mobile || ''} ${c.coCoordName1 || ''} ${c.coCoordMobile1 || ''} ${c.coCoordName2 || ''} ${c.coCoordMobile2 || ''}`.toLowerCase();
          if (searchTerm && !searchableText.includes(searchTerm)) continue;
          filtered.push({id: docSnap.id, eventNameId, eventName, ...c});
        }
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      coordPage = Math.min(coordPage || 1, totalPages);
      const pageCoords = filtered.slice((coordPage - 1) * PAGE_SIZE, coordPage * PAGE_SIZE);

      for (const c of pageCoords) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${c.eventName}</td><td>${c.mandal || '-'}</td><td>${c.name || '-'}</td><td>${c.mobile || '-'}</td><td>${c.coCoordName1 || '-'}</td><td>${c.coCoordMobile1 || '-'}</td><td>${c.coCoordName2 || '-'}</td><td>${c.coCoordMobile2 || '-'}</td><td><button class="action-btn" onclick="editCoordinator('${c.eventNameId}','${c.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteCoordinator('${c.eventNameId}','${c.id}')">üóëÔ∏è</button></td>`;
        coordinatorList.appendChild(row);
      }
      document.getElementById('coordPagination').innerHTML = `<button onclick="changeCoordPage(-1)" ${coordPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${coordPage}/${totalPages} <button onclick="changeCoordPage(1)" ${coordPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.loadReports = async function() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = ''; document.getElementById('reportPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const searchTerm = document.getElementById('reportSearch')?.value.toLowerCase() || '';

      let allReports = [];
      const eventNamesSnap = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNamesSnap.docs) {
        const eventNameId = eventNameDoc.id;
        if (!activeEventIds.has(eventNameId)) continue;

        const eventName = eventNameDoc.data().name || '';
        const reportsSnap = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        for (const docSnap of reportsSnap.docs) {
          allReports.push({id: docSnap.id, eventNameId, name: eventName, ...docSnap.data()});
        }
      }

      let filtered = allReports.filter(r => {
        if (filterEventId && r.eventNameId !== filterEventId) return false;
        if (filterMandalVal && r.mandal !== filterMandalVal) return false;
        const searchableText = `${r.name} ${r.mandal || ''} ${r.location || ''} ${r.guests || ''} ${r.details || ''}`.toLowerCase();
        if (searchTerm && !searchableText.includes(searchTerm)) return false;
        return true;
      });

      const reportedMandals = new Set(allReports.filter(r => filterEventId ? r.eventNameId === filterEventId : true).map(r => r.mandal));
      let pendingMandals = mandals.filter(m => !reportedMandals.has(m));
      const pendingText = pendingMandals.length ? `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç: ${pendingMandals.join(", ")}` : '‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§∏‡•á ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡•§';
      document.getElementById('pendingMandals').innerText = (filterEventId && pendingMandals.length) ? pendingText : '';

      const currentKey = `${filterEventId}-${pendingMandals.join("|")}`;
      if (filterEventId && currentKey !== lastPendingKey) {
        lastPendingKey = currentKey;
        await sendTelegramAlert(
          pendingMandals.length
            ? `üîî *${eventNameMap[filterEventId]}*: ${pendingMandals.length} ‡§Æ‡§Ç‡§°‡§≤ ‡§∂‡•á‡§∑ - ${pendingMandals.join(", ")}`
            : `‚úÖ *${eventNameMap[filterEventId]}*: ‡§∏‡§≠‡•Ä ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§‡•§`
        );
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      reportPage = Math.min(reportPage || 1, totalPages);
      const pageReports = filtered.slice((reportPage - 1) * PAGE_SIZE, reportPage * PAGE_SIZE);

      for (const r of pageReports) {
        let photosHTML = "";
        if (Array.isArray(r.photos) && r.photos.length > 0) {
          photosHTML = `<div class="report-photos-grid">${r.photos.slice(0,6).map(url => `<img src="${url}" onclick="zoomImage(event, '${url}')">`).join('')}</div>`;
        }
        const row = document.createElement('tr');
        row.innerHTML = `<td>${r.name}</td><td>${r.mandal || '-'}</td><td>${r.location || '-'}</td><td>${r.date || '-'}</td><td>${r.attendance || '-'}</td><td>${r.guests || '-'}</td><td>${r.details || '-'}</td><td>${photosHTML}</td><td><button class="action-btn" onclick="editReport('${r.eventNameId}','${r.id}')">‚úèÔ∏è</button><button class="action-btn delete" onclick="deleteReport('${r.eventNameId}','${r.id}')">üóëÔ∏è</button></td>`;
        reportList.appendChild(row);
      }
      document.getElementById('reportPagination').innerHTML = `<button onclick="changeReportPage(-1)" ${reportPage===1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button> ${reportPage}/${totalPages} <button onclick="changeReportPage(1)" ${reportPage===totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>`;
    };

    window.changeEventPage = function(diff) { eventPage = Math.max(1, eventPage + diff); loadEvents(); };
    window.changeCoordPage = function(diff) { coordPage = Math.max(1, coordPage + diff); loadCoordinators(); };
    window.changeReportPage = function(diff) { reportPage = Math.max(1, reportPage + diff); loadReports(); };

    window.editEvent = async function(id){ const docSnap = await getDoc(doc(db,"events",id)); if(!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!"); const e=docSnap.data(); const m=prompt("‡§Æ‡§Ç‡§°‡§≤:",e.mandal||""); if(m===null)return; const d=prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:",e.date||""); if(d===null)return; const t=prompt("‡§∏‡§Æ‡§Ø:",e.time||""); if(t===null)return; const l=prompt("‡§∏‡•ç‡§•‡§æ‡§®:",e.location||""); if(l===null)return; await updateDoc(doc(db,"events",id),{mandal:m,date:d,time:t,location:l}); await loadEvents(); };
    window.deleteEvent = async function(id){ if(confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")){ await deleteDoc(doc(db,"events",id)); await loadEvents(); } };

    window.editCoordinator = async function(eventNameId,coordId){ const docSnap=await getDoc(doc(db,`eventNames/${eventNameId}/coordinators`,coordId)); if(!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!"); const c=docSnap.data(); const m=prompt("‡§Æ‡§Ç‡§°‡§≤:",c.mandal||""); if(m===null)return; const n=prompt("‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï:",c.name||""); if(n===null)return; const mb=prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:",c.mobile||""); if(mb===null)return; const n1=prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 1:",c.coCoordName1||""); if(n1===null)return; const mb1=prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 1:",c.coCoordMobile1||""); if(mb1===null)return; const n2=prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 2:",c.coCoordName2||""); if(n2===null)return; const mb2=prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 2:",c.coCoordMobile2||""); if(mb2===null)return; await updateDoc(doc(db,`eventNames/${eventNameId}/coordinators`,coordId),{mandal:m,name:n,mobile:mb,coCoordName1:n1,coCoordMobile1:mb1,coCoordName2:n2,coCoordMobile2:mb2}); await loadCoordinators(); };
    window.deleteCoordinator = async function(eventNameId,coordId){ if(confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")){ await deleteDoc(doc(db,`eventNames/${eventNameId}/coordinators`,coordId)); await loadCoordinators(); } };

    window.editReport = async function(eventNameId,reportId){ const docSnap=await getDoc(doc(db,`eventNames/${eventNameId}/reports`,reportId)); if(!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!"); const r=docSnap.data(); const m=prompt("‡§Æ‡§Ç‡§°‡§≤:",r.mandal||""); if(m===null)return; const loc=prompt("‡§∏‡•ç‡§•‡§æ‡§®:",r.location||""); if(loc===null)return; const d=prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:",r.date||""); if(d===null)return; const a=prompt("‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø:",r.attendance||""); if(a===null)return; const g=prompt("‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø:",r.guests||""); if(g===null)return; const det=prompt("‡§µ‡§ø‡§µ‡§∞‡§£:",r.details||""); if(det===null)return; await updateDoc(doc(db,`eventNames/${eventNameId}/reports`,reportId),{mandal:m,location:loc,date:d,attendance:a,guests:g,details:det}); await loadReports(); };
    window.deleteReport = async function(eventNameId,reportId){ if(confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")){ await deleteDoc(doc(db,`eventNames/${eventNameId}/reports`,reportId)); await loadReports(); } };

    window.zoomImage = function(e,url){ e.preventDefault(); document.getElementById('imgZoomModalImg').src=url; document.getElementById('imgZoomModal').style.display='flex'; };
    document.getElementById('imgZoomModal').onclick=function(){ this.style.display='none'; document.getElementById('imgZoomModalImg').src=''; };

    async function loadListsOnly(){ await Promise.all([loadEvents(),loadCoordinators(),loadReports()]); }
    async function loadAll(){ await loadEventNames(); await loadListsOnly(); }
    loadAll();

    /* --------- DATA-FIRST for Reports ---------- */
    window.gatherReportsData = async function({onlyForEventId, filterMandalVal, searchTerm}){
      let all=[]; if(!onlyForEventId) return all;
      const reportsSnap = await getDocs(collection(db,`eventNames/${onlyForEventId}/reports`));
      for(const docSnap of reportsSnap.docs){ const r=docSnap.data(); all.push({id:docSnap.id,...r}); }
      let filtered = all.filter(r=>{
        if(filterMandalVal && r.mandal!==filterMandalVal) return false;
        const searchable=`${r.mandal||''} ${r.location||''} ${r.guests||''} ${r.details||''}`.toLowerCase();
        if(searchTerm && !searchable.includes((searchTerm||'').toLowerCase())) return false;
        return true;
      });
      filtered.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
      return filtered;
    };

    window.buildReportExportDOM = function({partyHeaderText, eventNameText, rows}){
      const root=document.getElementById('exportDocRoot');
      root.innerHTML=''; root.style.display='block';

      const header=document.createElement('div');
      header.className='header';
      header.innerHTML=`<h1>${partyHeaderText}</h1><h2>${eventNameText}</h2>`;
      root.appendChild(header);

      const table=document.createElement('table');
      table.innerHTML=`
        <thead>
          <tr>
            <th style="width:14%">‡§Æ‡§Ç‡§°‡§≤</th>
            <th style="width:14%">‡§∏‡•ç‡§•‡§æ‡§®</th>
            <th style="width:10%">‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
            <th style="width:10%">‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
            <th style="width:18%">‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø</th>
            <th style="width:24%">‡§µ‡§ø‡§µ‡§∞‡§£</th>
            <th style="width:10%">‡§´‡•ã‡§ü‡•ã</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      const tbody=table.querySelector('tbody');

      rows.forEach(r=>{
        const tr=document.createElement('tr');

        const tdM=document.createElement('td'); tdM.textContent=r.mandal||'-';
        const tdL=document.createElement('td'); tdL.textContent=r.location||'-';
        const tdD=document.createElement('td'); tdD.textContent=r.date||'-';
        const tdA=document.createElement('td'); tdA.textContent=r.attendance||'-';
        const tdG=document.createElement('td'); tdG.textContent=r.guests||'-';
        const tdDe=document.createElement('td'); tdDe.textContent=r.details||'-';

        const tdP=document.createElement('td'); const wrap=document.createElement('div'); wrap.className='photos';
        if(Array.isArray(r.photos) && r.photos.length){
          r.photos.slice(0,10).forEach(url=>{
            const img=document.createElement('img');
            img.crossOrigin='anonymous';
            img.referrerPolicy='no-referrer';
            img.loading='eager';
            img.decoding='sync';
            img.src=url;
            wrap.appendChild(img);
          });
        } else { wrap.textContent='-'; }
        tdP.appendChild(wrap);

        [tdM,tdL,tdD,tdA,tdG,tdDe,tdP].forEach(td=>tr.appendChild(td));
        tbody.appendChild(tr);
      });

      root.appendChild(table);
      return root;
    };
  </script>

  <!-- ============== Fast html2canvas + Landscape PDF + Image Inlining ============== -->
  <script>
    /* ‡§∏‡§≠‡•Ä <img> ‡§ï‡•ã DataURL ‡§Æ‡•á‡§Ç inline ‡§ï‡§∞‡•á‡§Ç (CORS-safe) */
    async function inlineImagesToDataURL(root, { concurrency=6 } = {}){
      const imgs = Array.from(root.querySelectorAll('img')).filter(img=>img.src);
      let i=0;
      async function worker(){
        while(i<imgs.length){
          const img = imgs[i++];
          try{
            const prox = `https://images.weserv.nl/?url=${encodeURIComponent(img.src)}`;
            const res = await fetch(prox, { cache:'no-store' });
            const blob = await res.blob();
            await new Promise(r=>{
              const fr=new FileReader();
              fr.onloadend=()=>{ img.src=fr.result; r(); };
              fr.readAsDataURL(blob);
            });
          }catch(e){ /* ignore this image */ }
        }
      }
      await Promise.all(Array.from({length:Math.min(concurrency, imgs.length)}, worker));
    }

    async function html2canvasSmart(element, { fast=false } = {}){
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      if(fast){
        await Promise.all(Array.from(element.querySelectorAll('img')).map(img=>img.decode?.().catch(()=>{})));
        return await html2canvas(element,{
          useCORS:true, allowTaint:true, backgroundColor:"#fff", scale:1.5,
          windowWidth:element.scrollWidth, windowHeight:element.scrollHeight
        });
      }
      const images=Array.from(element.querySelectorAll('img'));
      const jobs=images.map(async(img)=>{
        if(!img.src) return;
        try{
          const prox=`https://images.weserv.nl/?url=${encodeURIComponent(img.src)}`;
          const res=await fetch(prox); const blob=await res.blob();
          await new Promise(reslv=>{ const fr=new FileReader(); fr.onloadend=()=>{ img.src=fr.result; reslv(); }; fr.readAsDataURL(blob); });
        }catch(e){}
      });
      await Promise.all(jobs);
      await Promise.all(images.map(img=>img.decode?.().catch(()=>{})));
      return await html2canvas(element,{
        useCORS:true, allowTaint:true, backgroundColor:"#fff", scale:2,
        windowWidth:element.scrollWidth, windowHeight:element.scrollHeight
      });
    }

    function exportCanvasToPdfMultiPage(canvas, fileName, { landscape=true, margin=18, jpegQuality=0.85 } = {}){
      const { jsPDF } = window.jspdf;
      const pdf=new jsPDF({ orientation:landscape?'landscape':'portrait', unit:'pt', format:'a4' });
      const pageW=pdf.internal.pageSize.getWidth();
      const pageH=pdf.internal.pageSize.getHeight();
      const ratio=(pageW - margin*2)/canvas.width;
      const sliceH=(pageH - margin*2)/ratio;

      let y=0, page=0;
      while(y<canvas.height){
        const cut=document.createElement('canvas');
        cut.width=canvas.width; cut.height=Math.min(sliceH, canvas.height - y);
        const ctx=cut.getContext('2d'); ctx.drawImage(canvas,0,-y);
        const imgData=cut.toDataURL('image/jpeg', jpegQuality);
        if(page>0) pdf.addPage();
        pdf.addImage(imgData,'JPEG', margin,margin, pageW-margin*2, cut.height*ratio);
        y+=sliceH; page++;
      }
      pdf.save(`${fileName}.pdf`);
    }

    function exportTableToExcel(table, title){
      if(!table) return alert("‡§è‡§ï‡•ç‡§∏‡•á‡§≤ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§∞‡§£‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!");
      const rows=Array.from(table.querySelectorAll('tr'));
      const data=rows.map(row=>Array.from(row.querySelectorAll("th, td"))
                        .filter(cell=>!cell.querySelector('div.report-photos-grid'))
                        .map(cell=>cell.innerText));
      if(data.length<2) return alert("‡§è‡§ï‡•ç‡§∏‡•á‡§≤ ‡§Æ‡•á‡§Ç ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
      const ws=XLSX.utils.aoa_to_sheet(data);
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, title);
      XLSX.writeFile(wb, `${title}.xlsx`);
    }

    window.handleExport = async function(){
      try{
        const value=document.getElementById('exportDropdown').value;
        if(!value) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!");
        const [category, type]=value.split('-');
        const fast = document.getElementById('fastMode')?.checked;
        const landscape = document.getElementById('landscapeMode')?.checked;

        /* ---------- REPORTS: ‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (‡§´‡•ã‡§ü‡•ã ‡§∏‡§π‡§ø‡§§) ---------- */
        if(category==='reports'){
          const sel=document.getElementById('filterEvent');
          const eventId=sel.value;
          const eventText=sel.options[sel.selectedIndex]?.text?.trim();
          if(!eventId){ alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§"); return; }

          const mandalFilter=document.getElementById('filterMandal').value || '';
          const searchTerm=document.getElementById('reportSearch').value || '';

          alert("‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡•á‡§ü‡§æ ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶");

          const rows=await window.gatherReportsData({ onlyForEventId:eventId, filterMandalVal:mandalFilter, searchTerm });
          if(!rows.length){ alert("‡§á‡§∏ ‡§ö‡§Ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§"); return; }

          const root=window.buildReportExportDOM({
            partyHeaderText:"‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ú‡§ø‡§≤‡§æ ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞",
            eventNameText:eventText || "‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
            rows
          });

          // DOM ‡§™‡•á‡§Ç‡§ü + ‡§á‡§Æ‡•á‡§ú ‡§á‡§®‡§≤‡§æ‡§á‡§® (CORS-safe)
          await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
          await inlineImagesToDataURL(root);    // << ‡§´‡•ã‡§ü‡•ã ‡§ï‡•ã DataURL ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ
          await Promise.all(Array.from(root.querySelectorAll('img')).map(i=>i.decode?.().catch(()=>{})));

          const canvas=await html2canvasSmart(root, { fast });
          const fileName="‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü-‡§∏‡•Ç‡§ö‡•Ä";

          if(type==='pdf'){
            exportCanvasToPdfMultiPage(canvas, fileName, { landscape, margin:18, jpegQuality: fast ? 0.8 : 0.9 });
          } else if(type==='jpg'){
            const a=document.createElement('a');
            a.href=canvas.toDataURL('image/jpeg', fast?0.8:0.9);
            a.download=`${fileName}.jpg`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
          } else if(type==='excel'){
            exportTableToExcel(root.querySelector('table'), fileName);
          }

          root.style.display='none'; root.innerHTML='';
          return;
        }

        /* ---------- Events/Coordinators: ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®-‡§ú‡•à‡§∏‡§æ ---------- */
        let selector='.container', fileName="", table;
        if(category==='events'){ fileName="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ-‡§∏‡•Ç‡§ö‡•Ä"; table=document.querySelector('#eventsTab table'); }
        else if(category==='coordinators'){ fileName="‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï-‡§∏‡•Ç‡§ö‡•Ä"; table=document.querySelector('#coordinatorsTab table'); }
        else { alert("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡•§"); return; }

        const sel=document.getElementById('filterEvent');
        const selectedEventText=sel.options[sel.selectedIndex]?.text?.trim() || "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
        document.getElementById('eventTitle').innerText = sel.value ? selectedEventText : "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";

        alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‚Ä¶");

        if(type==='excel'){
          exportTableToExcel(table, fileName);
        } else {
          const container=document.querySelector(selector);
          const canvas=await html2canvasSmart(container, { fast });
          if(type==='pdf'){
            exportCanvasToPdfMultiPage(canvas, fileName, { landscape, margin:18, jpegQuality: fast ? 0.8 : 0.9 });
          } else if(type==='jpg'){
            const a=document.createElement('a');
            a.href=canvas.toDataURL('image/jpeg', fast?0.8:0.9);
            a.download=`${fileName}.jpg`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
          }
        }
      }catch(err){
        console.error("Export error:", err);
        alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
      }
    };
  </script>
</body>
</html>
