<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <title>Dashboard ‚Äì Events/Reports/Coordinators</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ========== Libraries ========== -->
  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fafafa; color:#222}
    header{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#0b57d0; color:#fff;}
    header h1{font-size:18px; margin:0}
    .container{padding:16px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    select, button, input[type="text"]{padding:8px 10px; border:1px solid #ddd; border-radius:8px; background:#fff}
    button{cursor:pointer}
    button.primary{background:#0b57d0; color:#fff; border-color:#0b57d0}
    button.warn{background:#ea4335; color:#fff; border-color:#ea4335}
    .tabs{display:flex; gap:8px; margin:16px 0}
    .tab{padding:8px 12px; border-radius:8px; background:#e7eefc; cursor:pointer}
    .tab.active{background:#0b57d0; color:#fff}
    .card{background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.05)}
    table{width:100%; border-collapse:collapse; background:#fff}
    th, td{border-bottom:1px solid #eee; padding:8px 10px; text-align:left}
    th{background:#f7f7f7}
    .muted{opacity:.7}
    .right{margin-left:auto}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; background:#eef4ff}
    .ok{background:#e7f7ed; color:#137333}
    .bad{background:#fde8e8; color:#b42318}
    /* Program List Manager panel */
    dialog{border:none; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); width:min(900px, 95vw)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    .plm-table th,.plm-table td{border-bottom:1px solid #eee}
    .small{font-size:12px}
    .gap-8{gap:8px}
  </style>
</head>
<body>
<header>
  <h1>Dashboard</h1>
  <div class="row gap-8">
    <button id="btnPLM" class="primary">Program List Manager</button>
    <select id="exportDropdown" title="Download">
      <option value="">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡•á‡§Ç?</option>
      <option value="events-excel">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä (Excel)</option>
      <option value="events-pdf">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä (PDF)</option>
      <option value="events-jpg">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä (JPG)</option>

      <option value="coordinators-excel">‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä (Excel)</option>
      <option value="coordinators-pdf">‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä (PDF)</option>
      <option value="coordinators-jpg">‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä (JPG)</option>

      <option value="reports-excel">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä (Excel)</option>
      <option value="reports-pdf">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä (PDF)</option> <!-- ‚Üê ‡§Ø‡§π‡•Ä Telegram ‡§™‡§∞ ‡§≠‡•Ä ‡§ú‡§æ‡§è‡§ó‡§æ -->
      <option value="reports-jpg">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä (JPG)</option>
    </select>
    <button class="primary" onclick="handleExport()">Download</button>
  </div>
</header>

<div class="container">
  <!-- Global event choosers used by three different forms -->
  <div class="row card">
    <div><b>Event (Form)</b><br/><select id="eventName"></select></div>
    <div><b>Event (Coordinator)</b><br/><select id="coordEventName"></select></div>
    <div><b>Event (Report)</b><br/><select id="reportEventSelect"></select></div>
    <div class="right small muted">Default ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡•á-‡§Ü‡§™ ‡§ö‡•Å‡§®‡•á‡§ó‡§æ ‚úîÔ∏è</div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div id="tabEvents" class="tab active" onclick="switchTab('events')">Events</div>
    <div id="tabCoordinators" class="tab" onclick="switchTab('coordinators')">Coordinators</div>
    <div id="tabReports" class="tab" onclick="switchTab('reports')">Reports</div>
  </div>

  <!-- Events -->
  <section id="eventsTab" class="card">
    <div class="row">
      <span class="pill">Active events ‡§π‡•Ä dropdowns ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§§‡•á ‡§π‡•à‡§Ç</span>
    </div>
    <table id="eventsTable">
      <thead><tr><th>#</th><th>Event</th><th>Start</th><th>End</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Coordinators -->
  <section id="coordinatorsTab" class="card" style="display:none">
    <table id="coordTable">
      <thead><tr><th>#</th><th>Event</th><th>Mandala</th><th>Coordinator</th><th>Mobile</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Reports -->
  <section id="reportsTab" class="card" style="display:none">
    <div class="row">
      <div id="pendingChip" class="pill bad">Pending: ‚Äì</div>
      <div id="allDoneChip" class="pill ok" style="display:none">‡§∏‡§≠‡•Ä 21 ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü ‡§ó‡§à ‚úÖ</div>
      <button class="right" onclick="forceTelegramPendingAlert()">Pending Telegram Alert ‡§≠‡•á‡§ú‡•á‡§Ç</button>
    </div>
    <table id="reportsTable">
      <thead><tr><th>#</th><th>Event</th><th>Mandala</th><th>Submitted At</th><th>By</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- ========== Program List Manager (PLM) ========== -->
<dialog id="plmDialog">
  <form method="dialog">
    <header class="row" style="padding:8px 12px">
      <h3 style="margin:0">Program List Manager</h3>
      <button class="right" onclick="document.getElementById('plmDialog').close()">‚úñ</button>
    </header>
    <div class="container" style="padding:12px 16px 18px">
      <div class="muted small" style="margin-bottom:10px">
        ‡§Ø‡§π‡§æ‡§Å <b>Active</b> ‚úîÔ∏è ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§µ‡§π‡•Ä ‡§á‡§µ‡•á‡§Ç‡§ü ‡§§‡•Ä‡§®‡•ã‡§Ç dropdowns ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§ <b>Default</b> üîò ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§µ‡§π‡•Ä auto-select ‡§π‡•ã‡§ó‡§æ‡•§
      </div>
      <table class="plm-table" id="plmTable" style="width:100%">
        <thead>
          <tr><th>#</th><th>Event Name</th><th>Active</th><th>Default</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:12px">
        <button type="button" class="primary" onclick="savePLM()">Save</button>
        <button type="button" onclick="loadPLM()">Refresh</button>
        <div class="right small muted">Firestore collection: <code>events</code> (fields: <code>name, active, isDefault</code>)</div>
      </div>
    </div>
  </form>
</dialog>

<script>
/* =================== CONFIG: CHANGE THESE =================== */
// 1) Firebase
const firebaseConfig = {
  // TODO: ---- ‡§Ü‡§™‡§ï‡§æ Firebase config ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç ----
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

// 2) Telegram
// Bot ‡§¨‡§®‡§æ‡§ï‡§∞ ‡§®‡•Ä‡§ö‡•á Token/Chat Id ‡§≠‡§∞‡•á‡§Ç
window.TELEGRAM_BOT_TOKEN = "";   // ‚Üê required
window.TELEGRAM_CHAT_ID   = "";   // ‚Üê required (group/channel id or user id)

/* ===== Global State ===== */
let db, EVENTS = [], DEFAULT_EVENT_ID = null;
const ALL_MANDALS = [
  "M1","M2","M3","M4","M5","M6","M7","M8","M9","M10","M11",
  "M12","M13","M14","M15","M16","M17","M18","M19","M20","M21"
];

/* =================== INIT =================== */
(function init(){
  try{
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  }catch(e){
    console.warn("No Firestore API detected or Firebase init failed.", e);
  }

  // UI
  document.getElementById('btnPLM').addEventListener('click', ()=>{
    document.getElementById('plmDialog').showModal();
    loadPLM();
  });

  // Load events and fill dropdowns
  refreshAllEventUI();
})();

/* ===== Tabs ===== */
function switchTab(key){
  const tabs = ['events','coordinators','reports'];
  tabs.forEach(t=>{
    document.getElementById(`${t}Tab`).style.display = (t===key?'block':'none');
    document.getElementById(`tab${t[0].toUpperCase()+t.slice(1)}`).classList.toggle('active', t===key);
  });
}
  
/* =================== PROGRAM LIST MANAGER =================== */
async function loadPLM(){
  if(!db) return;
  const snap = await db.collection('events').orderBy('name').get();
  EVENTS = [];
  let tbody = document.querySelector('#plmTable tbody');
  tbody.innerHTML = '';
  let i=1; let defaultFound = false;

  snap.forEach(doc=>{
    const d = { id: doc.id, ...doc.data() };
    EVENTS.push(d);
    if(d.isDefault) { DEFAULT_EVENT_ID = d.id; defaultFound = true; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${d.name || '-'}</td>
      <td><input type="checkbox" ${d.active ? 'checked':''} data-kind="active" data-id="${d.id}"/></td>
      <td><input type="radio" name="defaultEvent" ${d.isDefault ? 'checked':''} data-kind="default" data-id="${d.id}"/></td>`;
    tbody.appendChild(tr);
  });
  if(!defaultFound) DEFAULT_EVENT_ID = null;
}

async function savePLM(){
  if(!db) return alert("Firestore not ready");
  const rows = Array.from(document.querySelectorAll('#plmTable tbody tr'));
  let chosenDefault = null;
  // Unset all defaults first
  const batch = db.batch();
  rows.forEach((tr)=>{
    const active = tr.querySelector('input[data-kind="active"]').checked;
    const id = tr.querySelector('input[data-kind="active"]').dataset.id;
    const isDefault = tr.querySelector('input[data-kind="default"]').checked;
    if(isDefault) chosenDefault = id;
    batch.update(db.collection('events').doc(id), { active, isDefault: false });
  });
  if(chosenDefault){
    batch.update(db.collection('events').doc(chosenDefault), { isDefault: true });
  }
  await batch.commit();
  alert("Saved ‚úÖ");
  refreshAllEventUI();
}

/* =================== DROPDOWNS (ACTIVE + DEFAULT) =================== */
async function refreshAllEventUI(){
  await loadEventNamesActive();  // fills 3 dropdowns + selects default
  await loadEventsTable();       // events grid
  await loadCoordinators();      // coordinators grid
  await loadReports();           // reports grid + pending + telegram logic
}

async function loadEventNamesActive(){
  if(!db) return;
  const snap = await db.collection('events').where('active','==', true).orderBy('name').get();
  const opts = [];
  let defaultOpt = null;
  snap.forEach(doc=>{
    const d = {id: doc.id, ...doc.data()};
    opts.push(d);
    if(d.isDefault) defaultOpt = d.id;
  });
  DEFAULT_EVENT_ID = defaultOpt || (opts[0]?.id || null);

  const fills = ['eventName','coordEventName','reportEventSelect'];
  fills.forEach(id=>{
    const sel = document.getElementById(id);
    sel.innerHTML = opts.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
    if(DEFAULT_EVENT_ID) sel.value = DEFAULT_EVENT_ID;
  });
}

/* =================== TABLES =================== */
async function loadEventsTable(){
  if(!db) return;
  const tbody = document.querySelector('#eventsTable tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('events').orderBy('name').get();
  let i=1;
  snap.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${d.name || '-'}</td>
      <td>${d.startDate || '-'}</td>
      <td>${d.endDate || '-'}</td>
      <td>${d.active ? 'Active' : 'Inactive'} ${d.isDefault ? '<span class="pill">Default</span>':''}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadCoordinators(){
  if(!db) return;
  const evId = document.getElementById('coordEventName').value || DEFAULT_EVENT_ID;
  const tbody = document.querySelector('#coordTable tbody');
  tbody.innerHTML = '';
  // expected schema: coordinators collection with fields {eventId, mandala, name, phone}
  const snap = await db.collection('coordinators').where('eventId','==', evId).orderBy('mandala').get();
  let i=1;
  snap.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${(d.eventName || '')}</td>
      <td>${d.mandala || '-'}</td>
      <td>${d.name || '-'}</td>
      <td>${d.phone || '-'}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadReports(){
  if(!db) return;
  const evId = document.getElementById('reportEventSelect').value || DEFAULT_EVENT_ID;
  const tbody = document.querySelector('#reportsTable tbody');
  tbody.innerHTML = '';

  // expected schema: reports with fields {eventId, mandala, submittedAt, submittedBy, ...}
  const snap = await db.collection('reports').where('eventId','==', evId).orderBy('mandala').get();
  const arrived = [];
  let i=1;
  snap.forEach(doc=>{
    const d = doc.data();
    arrived.push(String(d.mandala));
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i++}</td>
      <td>${d.eventName || '-'}</td>
      <td>${d.mandala || '-'}</td>
      <td>${(d.submittedAt && (new Date(d.submittedAt.seconds*1000)).toLocaleString()) || '-'}</td>
      <td>${d.submittedBy || '-'}</td>`;
    tbody.appendChild(tr);
  });

  // Pending logic
  const pending = ALL_MANDALS.filter(m => !arrived.includes(m));
  updatePendingUIAndMaybeTelegram(pending, evId);
}

/* =================== PENDING + TELEGRAM ALERTS =================== */
function pendingMessageText(pending, eventName="‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ"){
  if(pending.length === 0){
    return `‚úÖ ‡§∏‡§≠‡•Ä 21 ‡§Æ‡§Ç‡§°‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ö‡•Å‡§ï‡•Ä ‡§π‡•à‡•§\nüìå ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ: ${eventName}`;
  }
  return `üîî ‡§∂‡•á‡§∑ ‡§Æ‡§Ç‡§°‡§≤: ${pending.length}\nüßæ ${pending.join(', ')}\nüìå ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ: ${eventName}`;
}

async function updatePendingUIAndMaybeTelegram(pending, eventId){
  // UI
  const pendingChip = document.getElementById('pendingChip');
  const allDoneChip = document.getElementById('allDoneChip');
  if(pending.length === 0){
    pendingChip.style.display = 'none';
    allDoneChip.style.display = 'inline-block';
  }else{
    pendingChip.textContent = `Pending: ${pending.length} (${pending.join(', ')})`;
    pendingChip.style.display = 'inline-block';
    allDoneChip.style.display = 'none';
  }

  // Event name (for message)
  let eventName = '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ';
  try {
    const evDoc = await db.collection('events').doc(eventId).get();
    eventName = evDoc.data()?.name || eventName;
  } catch(e){}

  // Auto send alert every load (you can throttle if needed)
  await telegramSendText(pendingMessageText(pending, eventName));
}

async function forceTelegramPendingAlert(){
  // recompute from current table
  const rows = Array.from(document.querySelectorAll('#reportsTable tbody tr'));
  const arrived = rows.map(tr => tr.children[2]?.textContent).filter(Boolean);
  const pending = ALL_MANDALS.filter(m => !arrived.includes(m));
  const evId = document.getElementById('reportEventSelect').value || DEFAULT_EVENT_ID;

  let evName = '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ';
  try {
    const evDoc = await db.collection('events').doc(evId).get();
    evName = evDoc.data()?.name || evName;
  } catch(e){}
  await telegramSendText(pendingMessageText(pending, evName));
  alert('Pending list Telegram ‡§™‡§∞ ‡§≠‡•á‡§ú ‡§¶‡•Ä ‡§ó‡§à ‚úÖ');
}

/* =================== EXPORTS (EXCEL / PDF / JPG) =================== */
function exportTableToExcel(table, filename){
  // very-simple CSV (opens fine in Excel)
  let csv = [];
  for(const row of table.querySelectorAll('tr')){
    const cells = Array.from(row.children).map(td => `"${(td.innerText||'').replace(/"/g,'""')}"`);
    csv.push(cells.join(','));
  }
  const blob = new Blob([csv.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${filename}.csv`;
  a.click();
}

async function captureElementWithImages(selector){
  const el = document.querySelector(selector);
  // ensure images are loaded if any
  const imgs = el.querySelectorAll('img');
  await Promise.all(Array.from(imgs).map(i => i.complete ? Promise.resolve() : new Promise(res => { i.onload=res; i.onerror=res; })));
  return await html2canvas(el, {scale:2, useCORS:true, backgroundColor:'#ffffff'});
}

async function exportCanvasToPdf(canvas, fileName, {sendToTelegram=false} = {}){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
    unit: 'pt', format: 'a4'
  });

  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = pdf.internal.pageSize.getHeight();
  const ratio = canvas.width / canvas.height;
  let imgW, imgH;
  if (ratio > (pdfW/pdfH)) { imgW = pdfW - 40; imgH = imgW / ratio; }
  else { imgH = pdfH - 40; imgW = imgH * ratio; }
  const x = (pdfW - imgW) / 2, y = (pdfH - imgH) / 2;

  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);

  // Save locally
  pdf.save(`${fileName}.pdf`);

  if (sendToTelegram) {
    try {
      const blob = pdf.output('blob'); // PDF as Blob
      const fd = new FormData();
      fd.append('chat_id', window.TELEGRAM_CHAT_ID);
      fd.append('document', blob, `${fileName}.pdf`);
      await fetch(`https://api.telegram.org/bot${window.TELEGRAM_BOT_TOKEN}/sendDocument`, {
        method: 'POST',
        body: fd
      });
      alert('Telegram ‡§™‡§∞ PDF ‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úÖ');
    } catch (e) {
      console.error('Telegram ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', e);
      alert('Telegram ‡§™‡§∞ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§à‡•§');
    }
  }
}

function exportCanvasToJpg(canvas, fileName){
  canvas.toBlob((blob)=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${fileName}.jpg`;
    a.click();
  }, 'image/jpeg', 0.95);
}

async function handleExport(){
  try {
    const value = document.getElementById('exportDropdown').value;
    if (!value) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!");
    const [category, type] = value.split('-');

    let selector = `#${category}Tab`;
    let fileName = (category === 'events') ? "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ-‡§∏‡•Ç‡§ö‡•Ä"
                 : (category === 'coordinators') ? "‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï-‡§∏‡•Ç‡§ö‡•Ä"
                 : (category === 'reports') ? "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü-‡§∏‡•Ç‡§ö‡•Ä" : "";

    if (!fileName) return alert("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡•§");

    alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...");

    if (type === 'excel') {
      const table = document.querySelector(`${selector} table`);
      exportTableToExcel(table, fileName);
      return;
    }

    const canvas = await captureElementWithImages(selector);

    if (type === 'pdf') {
      const alsoTelegram = (category === 'reports'); // ‚Üê ‡§∏‡§ø‡§∞‡•ç‡§´‡§º ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü PDF ‡§™‡§∞ Telegram
      await exportCanvasToPdf(canvas, fileName, { sendToTelegram: alsoTelegram });
    } else if (type === 'jpg') {
      exportCanvasToJpg(canvas, fileName);
    }
  } catch (error) {
    console.error("‡§´‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
    alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
  }
}

/* =================== TELEGRAM HELPERS =================== */
async function telegramSendText(text){
  if(!window.TELEGRAM_BOT_TOKEN || !window.TELEGRAM_CHAT_ID) return;
  try{
    await fetch(`https://api.telegram.org/bot${window.TELEGRAM_BOT_TOKEN}/sendMessage`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: window.TELEGRAM_CHAT_ID, text})
    });
  }catch(e){ console.error('Telegram text error', e); }
}

/* =================== RELOAD ON DROPDOWN CHANGE =================== */
['eventName','coordEventName','reportEventSelect'].forEach(id=>{
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id === id){
      if(id === 'coordEventName') loadCoordinators();
      if(id === 'reportEventSelect') loadReports();
    }
  });
});
</script>
</body>
</html>
