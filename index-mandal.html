<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>मंडल पोर्टल — लॉगिन + डैशबोर्ड</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#fff9f3;color:#222;font-family:system-ui,'Noto Sans Devanagari',Arial,sans-serif;margin:0}
    .container{max-width:1100px;margin:20px auto;background:#fff6ea;border-radius:14px;box-shadow:0 2px 16px #ff980020;padding:16px}
    h1,h2{color:#e65100;margin:.2rem 0 .6rem}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #ffe0b2;border-radius:10px;padding:12px}
    label{font-weight:600;color:#8d4700;display:block;margin:.4rem 0 .2rem}
    input,select,textarea,button{font-size:1rem}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1.2px solid #ffa726a9;background:#fffaf5}
    input:focus,select:focus,textarea:focus{border-color:#ff9800;background:#fff7e0}
    button{background:#ff9800;border:none;color:#fff;border-radius:6px;padding:8px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#8d8d8d} button.danger{background:#e53935} button:hover{background:#e65100}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:.5rem 0}
    .tab-btn{background:#ffe0b2;color:#8d4700;border:none;padding:8px 14px;border-radius:8px 8px 0 0;font-weight:700;cursor:pointer}
    .tab-btn.active{background:#ff9800;color:#fff}
    .tab{display:none;background:#fff;border:1px solid #ffe0b2;border-top:none;border-radius:0 8px 8px 8px;padding:12px}
    .tab.active{display:block}
    table{width:100%;border-collapse:collapse;background:#fff;margin:.5rem 0}
    th,td{border:1px solid #ffa72655;padding:7px;text-align:left} th{background:#ffb74d;color:#442300}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.82rem}
    .badge.draft{background:#ffe0b2}.badge.pending{background:#fff59d}.badge.live{background:#c8e6c9}
    .hidden{display:none}.right{margin-left:auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin:.4rem 0}
  </style>
</head>
<body>
<div class="container">
  <h1>भारतीय जनता पार्टी — मंडल पोर्टल</h1>

  <!-- LOGIN GATE -->
  <div id="loginGate" class="card">
    <h2>मंडल अध्यक्ष लॉगिन</h2>
    <label>मंडल चुनें</label>
    <select id="selMandal"><option value="">-- मंडल चुनें --</option></select>

    <div id="mandalCard" style="display:none;margin:.6rem 0;padding:.6rem;border:1px dashed #ffcc80;border-radius:8px;background:#fff">
      <div><b>नाम:</b> <span id="md_name"></span></div>
      <div><b>मोबाइल:</b> <span id="md_mobile"></span></div>
      <div style="margin-top:.3rem;color:#8d4700;">आपका स्वागत है! आगे बढ़ने के लिए OTP डालें/भेजें।</div>
    </div>

    <div id="recaptcha-container" style="height:1px;overflow:hidden"></div>
    <div class="row" style="align-items:center">
      <input id="otpInput" placeholder="OTP (e.g. 123456)" style="flex:1 1 220px">
      <button id="btnSendOtp">OTP भेजें</button>
      <button id="btnVerify">Verify</button>
    </div>
    <div id="gateMsg" style="margin-top:.4rem;color:#8d4700"></div>
  </div>

  <!-- APP (unlock after verify) -->
  <div id="app" class="hidden">
    <div class="row" style="align-items:center">
      <div><b>लॉगिन:</b> <span id="who"></span></div>
      <div class="right">
        <a href="admin.html" id="adminLink" class="hidden"><button class="secondary">Admin Dashboard</button></a>
        <button id="logoutBtn" class="secondary">लॉगआउट</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-event">कार्यक्रम जोड़ें</button>
      <button class="tab-btn" data-tab="tab-report">रिपोर्ट</button>
      <button class="tab-btn" data-tab="tab-coord">संयोजक</button>
      <button class="tab-btn" data-tab="tab-my">मेरे सबमिशन / डाउनलोड</button>
    </div>

    <!-- नीचे का असली फॉर्म/टेबल सेक्शन आप पहले वाले वर्शन जैसा ही रखें (यहाँ संक्षेप रखा है) -->
    <div id="tab-event" class="tab active"><div class="card">लॉगिन सफल — अब फॉर्म्स सक्षम हैं।</div></div>
    <div id="tab-report" class="tab"><div class="card">रिपोर्ट फॉर्म…</div></div>
    <div id="tab-coord" class="tab"><div class="card">संयोजक फॉर्म…</div></div>
    <div id="tab-my" class="tab"><div class="card">मेरे सबमिशन/डाउनलोड…</div></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // --- Firebase (आपका) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Master Tester ---
  const MASTER_TESTER = { name:"Ankit Soni", phone:"+919893074891" };

  // --- Directory (PDF से तैयार) ---
  const DIRECTORY = {
    "भेंसोदा":      { name:"श्री उमेश पारीदार", phones:["+918349035165"] },
    "भानपुरा":      { name:"श्री आदित्य मंगरोतिया", phones:["+919179885982"] },
    "गरोठ":         { name:"श्री गोकुलचंद चौरसिया", phones:["+919827493573"] },
    "खड़ावदा":      { name:"श्री शीताराम चारण", phones:["+919826396638"] },
    "मेलखेडा":      { name:"श्री महेंद्र पहाड़िया", phones:["+919754473805"] },
    "शामगढ़":        { name:"श्रीमती नीलकमल मेहता", phones:["+919584127575"] },
    "सुवासरा":      { name:"श्री दिलीपसिंह तरनोद", phones:["+918959312353","+919302610609"] },
    "बसाई":         { name:"श्री जुझारसिंह गुर्जर", phones:["+917470494609"] },
    "सीतामऊ ग्रामीण": { name:"श्री धनुख पारीदार", phones:["+919826333757"] },
    "सीतामऊ":       { name:"श्री जितेन्द्र बामनिया", phones:["+917067415463","+917049850975"] },
    "क्यामपुर":      { name:"श्री महेंद्रसिंह गवाड़", phones:["+919926571895"] },
    "धुंधधड़का":     { name:"श्री राजेश धाकड़", phones:["+919926629819"] },
    "गुर्जर बरडिया": { name:"श्री भेरलाल जैन", phones:["+919009307527"] },
    "पिपलिया मंडी":  { name:"श्री राकेश पारीदार", phones:["+918120841685"] },
    "मल्हारगढ़":     { name:"श्री आशीष विजयवर्गीय", phones:["+919300609496"] },
    "बुढा":         { name:"श्री सुदर्शन शर्मा", phones:["+917869116615"] },
    "दलोदा":        { name:"श्री सुमित जैन", phones:["+917000153438"] },
    "मगरामाता जी":  { name:"श्री गोपाल पारीदार", phones:["+917000422830"] },
    "मंदसौर ग्रामीण": { name:"श्री नेपालसिंह जाट", phones:["+919009284622"] },
    "मंदसौर उत्तर":  { name:"श्री अरविंद पारसत", phones:["+919827227627"] },
    "मंदसौर दक्षिण": { name:"श्री दिनोद डगवार", phones:["+919406869388"] }
  };

  // --- UI refs ---
  const loginGate = document.getElementById('loginGate');
  const appRoot   = document.getElementById('app');
  const gateMsg   = document.getElementById('gateMsg');
  const selMandal = document.getElementById('selMandal');
  const md_name = document.getElementById('md_name');
  const md_mobile = document.getElementById('md_mobile');
  const mandalCard = document.getElementById('mandalCard');
  const who = document.getElementById('who');
  const otpInput = document.getElementById('otpInput');
  const btnSendOtp = document.getElementById('btnSendOtp');
  const btnVerify = document.getElementById('btnVerify');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminLink = document.getElementById('adminLink');

  // Fill dropdown
  Object.keys(DIRECTORY).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; selMandal.appendChild(o); });

  selMandal.onchange = ()=>{
    const d = DIRECTORY[selMandal.value];
    if(!d){ mandalCard.style.display='none'; md_name.textContent=""; md_mobile.textContent=""; return; }
    md_name.textContent = d.name || "—";
    md_mobile.textContent = (d.phones||[]).join(", ");
    mandalCard.style.display = 'block';
  };

  let recaptcha = null, confirmationResult = null, profile = null;

  // Invisible reCAPTCHA + OTP send (Master Tester number)
  btnSendOtp.onclick = async ()=>{
    gateMsg.textContent = "";
    // Master tester number का इस्तेमाल (टेस्ट आसान रखने के लिए)
    const phoneToUse = MASTER_TESTER.phone;

    try{
      if(!recaptcha){
        recaptcha = new RecaptchaVerifier(auth,'recaptcha-container',{ size:'invisible', callback:()=>{} });
      }
      confirmationResult = await signInWithPhoneNumber(auth, phoneToUse, recaptcha);
      gateMsg.textContent = `OTP भेजी गई: ${phoneToUse}`;
    }catch(err){
      const msg = err?.customData?.serverResponse || err?.message || String(err);
      gateMsg.textContent = "OTP भेजने में दिक्कत: " + msg;
      console.error(err);
    }
  };

  // Verify → save user → unlock
  btnVerify.onclick = async ()=>{
    try{
      await confirmationResult.confirm(otpInput.value.trim());
      gateMsg.textContent = "मोबाइल सत्यापित!";
    }catch(err){
      gateMsg.textContent = "OTP verify विफल: " + (err?.message||err);
      console.error(err); return;
    }
  };

  // Save user profile safely (400 fix: correct doc path & fields)
  async function saveUserData(user){
    try{
      const selectedMandal = selMandal.value?.trim() || "—";
      // Master tester = admin
      const payload = {
        uid: user.uid,
        role: "admin",
        name: MASTER_TESTER.name,
        mobile: MASTER_TESTER.phone,
        mandal: selectedMandal,
        verified: true,
        updatedAt: serverTimestamp()
      };
      await setDoc(doc(db,'users', user.uid), payload, { merge:true });
      return payload;
    }catch(e){
      console.error("User save failed:", e);
      gateMsg.textContent = "प्रोफ़ाइल सेव में दिक्कत: " + (e?.message||e);
      throw e;
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      try{
        const u = await saveUserData(user);
        profile = { uid: user.uid, ...u };
        who.textContent = `${profile.mandal} • ${profile.name} • ${profile.mobile}`;
        adminLink.classList.remove('hidden'); // master can see admin
        loginGate.classList.add('hidden');
        appRoot.classList.remove('hidden');
      }catch(e){ /* ऊपर मैसेज दिख चुका */ }
    }else{
      profile=null;
      appRoot.classList.add('hidden');
      loginGate.classList.remove('hidden');
      gateMsg.textContent="";
    }
  });

  logoutBtn.onclick = ()=> signOut(auth);
</script>
</body>
</html>
