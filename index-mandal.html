<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>मंडल पोर्टल — लॉगिन + डैशबोर्ड</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#fff9f3;color:#222;font-family:system-ui,'Noto Sans Devanagari',Arial,sans-serif;margin:0}
    .container{max-width:1100px;margin:20px auto;background:#fff6ea;border-radius:14px;box-shadow:0 2px 16px #ff980020;padding:16px}
    h1,h2{color:#e65100;margin:.2rem 0 .6rem}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #ffe0b2;border-radius:10px;padding:12px}
    label{font-weight:600;color:#8d4700;display:block;margin:.4rem 0 .2rem}
    input,select,textarea,button{font-size:1rem}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1.2px solid #ffa726a9;background:#fffaf5}
    input:focus,select:focus,textarea:focus{border-color:#ff9800;background:#fff7e0}
    button{background:#ff9800;border:none;color:#fff;border-radius:6px;padding:8px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#8d8d8d} button.danger{background:#e53935} button:hover{background:#e65100}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:.5rem 0}
    .tab-btn{background:#ffe0b2;color:#8d4700;border:none;padding:8px 14px;border-radius:8px 8px 0 0;font-weight:700;cursor:pointer}
    .tab-btn.active{background:#ff9800;color:#fff}
    .tab{display:none;background:#fff;border:1px solid #ffe0b2;border-top:none;border-radius:0 8px 8px 8px;padding:12px}
    .tab.active{display:block}
    table{width:100%;border-collapse:collapse;background:#fff;margin:.5rem 0}
    th,td{border:1px solid #ffa72655;padding:7px;text-align:left} th{background:#ffb74d;color:#442300}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.82rem}
    .badge.draft{background:#ffe0b2}.badge.pending{background:#fff59d}.badge.live{background:#c8e6c9}
    .hidden{display:none}.right{margin-left:auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin:.4rem 0}
  </style>
</head>
<body>
<div class="container">
  <h1>भारतीय जनता पार्टी — मंडल पोर्टल</h1>

  <!-- LOGIN GATE -->
  <div id="loginGate" class="card">
    <h2>मंडल अध्यक्ष लॉगिन</h2>
    <label>मंडल चुनें</label>
    <select id="selMandal"><option value="">-- मंडल चुनें --</option></select>

    <div id="mandalCard" style="display:none;margin:.6rem 0;padding:.6rem;border:1px dashed #ffcc80;border-radius:8px;background:#fff">
      <div><b>नाम:</b> <span id="md_name"></span></div>
      <div><b>मोबाइल:</b> <span id="md_mobile"></span></div>
      <div style="margin-top:.3rem;color:#8d4700;">आपका स्वागत है! आगे बढ़ने के लिए OTP डालें/भेजें।</div>
    </div>

    <div id="recaptcha-container" style="height:1px;overflow:hidden"></div>
    <div class="row" style="align-items:center">
      <input id="otpInput" placeholder="OTP" style="flex:1 1 220px">
      <button id="btnSendOtp">OTP भेजें</button>
      <button id="btnVerify">Verify</button>
    </div>
    <div id="gateMsg" style="margin-top:.4rem;color:#8d4700"></div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="row" style="align-items:center">
      <div><b>लॉगिन:</b> <span id="who"></span></div>
      <div class="right"><a href="admin.html" id="adminLink" class="hidden"><button class="secondary">Admin Dashboard</button></a>
      <button id="logoutBtn" class="secondary">लॉगआउट</button></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-event">कार्यक्रम जोड़ें</button>
      <button class="tab-btn" data-tab="tab-report">रिपोर्ट</button>
      <button class="tab-btn" data-tab="tab-coord">संयोजक</button>
      <button class="tab-btn" data-tab="tab-my">मेरे सबमिशन / डाउनलोड</button>
    </div>

    <!-- कार्यक्रम -->
    <div id="tab-event" class="tab active">
      <div class="row">
        <div class="card" style="flex:1 1 340px">
          <h3>नई प्रविष्टि</h3>
          <label>कार्यक्रम</label>
          <select id="ev_eventName"><option value="">कार्यक्रम चुनें</option></select>
          <label>मंडल</label><input id="ev_mandal" disabled>
          <label>तारीख</label><input id="ev_date" type="date">
          <label>समय</label><input id="ev_time" type="time">
          <label>स्थान</label><input id="ev_location">
          <div class="row" style="margin-top:.6rem">
            <button id="ev_saveDraft">Save Draft</button>
            <button id="ev_submit">Submit for Approval</button>
          </div>
          <div id="ev_msg" style="margin-top:.4rem;color:#8d4700"></div>
        </div>
        <div class="card" style="flex:1 1 520px">
          <div class="toolbar">
            <input id="ev_search" placeholder="खोजें (स्थान/तारीख)">
            <button id="ev_download" class="secondary">CSV डाउनलोड</button>
          </div>
          <table id="ev_table"><thead><tr><th>कार्यक्रम</th><th>तारीख</th><th>समय</th><th>स्थान</th><th>स्थिति</th><th>एक्शन</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- रिपोर्ट -->
    <div id="tab-report" class="tab">
      <div class="row">
        <div class="card" style="flex:1 1 340px">
          <h3>नई रिपोर्ट</h3>
          <label>कार्यक्रम</label><select id="rp_eventName"><option value="">कार्यक्रम चुनें</option></select>
          <label>मंडल</label><input id="rp_mandal" disabled>
          <label>स्थान</label><input id="rp_location">
          <label>उपस्थिति</label><input id="rp_attendance" type="number">
          <label>दिनांक</label><input id="rp_date" type="date">
          <label>विशिष्ट अतिथि</label><input id="rp_guests">
          <label>विवरण</label><textarea id="rp_details" rows="3"></textarea>
          <label>फोटो</label><input id="rp_photo" type="file" accept="image/*">
          <div class="row" style="margin-top:.6rem">
            <button id="rp_saveDraft">Save Draft</button>
            <button id="rp_submit">Submit for Approval</button>
          </div>
          <div id="rp_msg" style="margin-top:.4rem;color:#8d4700"></div>
        </div>
        <div class="card" style="flex:1 1 520px">
          <div class="toolbar">
            <input id="rp_search" placeholder="खोजें (तारीख/उपस्थिति/विवरण)">
            <button id="rp_download" class="secondary">CSV डाउनलोड</button>
          </div>
          <table id="rp_table"><thead><tr><th>कार्यक्रम</th><th>तारीख</th><th>उपस्थिति</th><th>स्थिति</th><th>एक्शन</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- संयोजक -->
    <div id="tab-coord" class="tab">
      <div class="row">
        <div class="card" style="flex:1 1 340px">
          <h3>संयोजक जोड़ें</h3>
          <label>कार्यक्रम</label><select id="cd_eventName"><option value="">कार्यक्रम चुनें</option></select>
          <label>मंडल</label><input id="cd_mandal" disabled>
          <label>संयोजक</label><input id="cd_name">
          <label>मोबाइल</label><input id="cd_mobile">
          <label>सह-संयोजक 1</label><input id="cd_c1">
          <label>मोबाइल 1</label><input id="cd_c1m">
          <label>सह-संयोजक 2</label><input id="cd_c2">
          <label>मोबाइल 2</label><input id="cd_c2m">
          <div class="row" style="margin-top:.6rem">
            <button id="cd_saveDraft">Save Draft</button>
            <button id="cd_submit">Submit for Approval</button>
          </div>
          <div id="cd_msg" style="margin-top:.4rem;color:#8d4700"></div>
        </div>
        <div class="card" style="flex:1 1 520px">
          <div class="toolbar">
            <input id="cd_search" placeholder="खोजें (नाम/मोबाइल)">
            <button id="cd_download" class="secondary">CSV डाउनलोड</button>
          </div>
          <table id="cd_table"><thead><tr><th>कार्यक्रम</th><th>संयोजक</th><th>मोबाइल</th><th>स्थिति</th><th>एक्शन</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- मेरे सबमिशन / डाउनलोड -->
    <div id="tab-my" class="tab">
      <div class="row">
        <div class="card" style="flex:1 1 320px">
          <h3>मेरे मंडल का सार</h3>
          <div id="my_stats">लोड हो रहा…</div>
          <div class="row" style="margin-top:.6rem">
            <button id="exportAll" class="secondary">मेरी LIVE एंट्री (CSV)</button>
          </div>
        </div>
        <div class="card" style="flex:2 1 520px">
          <div class="toolbar"><input id="live_search" placeholder="LIVE डेटा खोजें (कार्यक्रम/नाम/विवरण)"></div>
          <h3>मेरी LIVE एंट्री</h3>
          <table id="my_live"><thead><tr><th>प्रकार</th><th>कार्यक्रम</th><th>तारीख/नाम</th><th>विवरण</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:16px;border-radius:10px;min-width:320px;max-width:520px">
        <h3 id="em_title" style="margin-top:0">Edit</h3>
        <div id="em_body"></div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="em_cancel" class="secondary">Cancel</button>
          <button id="em_save">Save</button>
        </div>
      </div>
    </div>

  </div><!-- /app -->
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  // --- Firebase (आपका) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- Master Tester (सभी मंडलों के लिए) ---
  const MASTER_TESTER = { name:"Ankit Soni", phone:"+919893074891" };

  // --- Directory (PDF से) ---  :contentReference[oaicite:2]{index=2}
  const DIRECTORY = {
    "भेंसोदा":      { name:"श्री उमेश पारीदार", phones:["+918349035165"] },
    "भानपुरा":      { name:"श्री आदित्य मंगरोतिया", phones:["+919179885982"] },
    "गरोठ":         { name:"श्री गोकुलचंद चौरसिया", phones:["+919827493573"] },
    "खड़ावदा":      { name:"श्री शीताराम चारण", phones:["+919826396638"] },
    "मेलखेडा":      { name:"श्री महेंद्र पहाड़िया", phones:["+919754473805"] },
    "शामगढ़":        { name:"श्रीमती नीलकमल मेहता", phones:["+919584127575"] },
    "सुवासरा":      { name:"श्री दिलीपसिंह तरनोद", phones:["+918959312353","+919302610609"] },
    "बसाई":         { name:"श्री जुझारसिंह गुर्जर", phones:["+917470494609"] },
    "सीतामऊ ग्रामीण": { name:"श्री धनुख पारीदार", phones:["+919826333757"] },
    "सीतामऊ":       { name:"श्री जितेन्द्र बामनिया", phones:["+917067415463","+917049850975"] },
    "क्यामपुर":      { name:"श्री महेंद्रसिंह गवाड़", phones:["+919926571895"] },
    "धुंधधड़का":     { name:"श्री राजेश धाकड़", phones:["+919926629819"] },
    "गुर्जर बरडिया": { name:"श्री भेरलाल जैन", phones:["+919009307527"] },
    "पिपलिया मंडी":  { name:"श्री राकेश पारीदार", phones:["+918120841685"] },
    "मल्हारगढ़":     { name:"श्री आशीष विजयवर्गीय", phones:["+919300609496"] },
    "बुढा":         { name:"श्री सुदर्शन शर्मा", phones:["+917869116615"] },
    "दलोदा":        { name:"श्री सुमित जैन", phones:["+917000153438"] },
    "मगरामाता जी":  { name:"श्री गोपाल पारीदार", phones:["+917000422830"] },
    "मंदसौर ग्रामीण": { name:"श्री नेपालसिंह जाट", phones:["+919009284622"] },
    "मंदसौर उत्तर":  { name:"श्री अरविंद पारसत", phones:["+919827227627"] },
    "मंदसौर दक्षिण": { name:"श्री दिनोद डगवार", phones:["+919406869388"] }
  };

  // --- UI refs ---
  const loginGate = document.getElementById('loginGate');
  const appRoot   = document.getElementById('app');
  const gateMsg   = document.getElementById('gateMsg');
  const selMandal = document.getElementById('selMandal');
  const md_name = document.getElementById('md_name');
  const md_mobile = document.getElementById('md_mobile');
  const mandalCard = document.getElementById('mandalCard');
  const who = document.getElementById('who');
  const otpInput = document.getElementById('otpInput');
  const btnSendOtp = document.getElementById('btnSendOtp');
  const btnVerify = document.getElementById('btnVerify');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminLink = document.getElementById('adminLink');

  // Tabs
  const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
  tabBtns.forEach(b=> b.onclick = ()=> {
    tabBtns.forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById(b.dataset.tab).classList.add('active');
  });

  // Dropdown fill
  Object.keys(DIRECTORY).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; selMandal.appendChild(o); });

  selMandal.onchange = ()=>{
    const d = DIRECTORY[selMandal.value];
    if(!d){ mandalCard.style.display='none'; md_name.textContent=""; md_mobile.textContent=""; return; }
    md_name.textContent = d.name || "—";
    md_mobile.textContent = (d.phones||[]).join(", ");
    mandalCard.style.display = 'block';
  };

  let recaptcha = null, confirmationResult = null, profile = null;

  // Invisible reCAPTCHA + OTP send
  btnSendOtp.onclick = async ()=>{
    gateMsg.textContent = "";
    const selected = selMandal.value?.trim();
    let phoneToUse = MASTER_TESTER.phone; // master tester always wins
    let displayName = MASTER_TESTER.name + " (Master Tester)";

    if(!recaptcha){
      recaptcha = new RecaptchaVerifier(auth,'recaptcha-container',{ size:'invisible', callback:()=>{} });
    }
    try{
      confirmationResult = await signInWithPhoneNumber(auth, phoneToUse, recaptcha);
      gateMsg.textContent = `OTP भेजी गई: ${phoneToUse}`;
    }catch(err){
      gateMsg.textContent = "OTP भेजने में दिक्कत: " + (err?.message||err);
      console.error(err);
    }
  };

  // Verify → profile set → unlock UI
  btnVerify.onclick = async ()=>{
    try{
      await confirmationResult.confirm(otpInput.value.trim());
      gateMsg.textContent = "मोबाइल सत्यापित!";
    }catch(err){
      gateMsg.textContent = "OTP verify विफल: " + (err?.message||err);
      console.error(err); return;
    }
  };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      const selected = selMandal.value?.trim();
      const uid = user.uid;

      // Master tester = admin + किसी भी मंडल पर टेस्ट
      const finalRole  = "admin";
      const finalMandal= selected || "—";
      const finalName  = MASTER_TESTER.name;
      const finalPhone = MASTER_TESTER.phone;

      await setDoc(doc(db,'users',uid), {
        role: finalRole, mandal: finalMandal, name: finalName, mobile: finalPhone, updatedAt: serverTimestamp()
      }, {merge:true});

      const u = await getDoc(doc(db,'users',uid));
      profile = { uid, ...(u.exists()?u.data():{}) };

      who.textContent = `${profile.mandal} • ${profile.name} • ${profile.mobile}`;
      adminLink.classList.remove('hidden');      // master can see admin
      loginGate.classList.add('hidden'); appRoot.classList.remove('hidden');

      document.getElementById('ev_mandal').value = profile.mandal;
      document.getElementById('rp_mandal').value = profile.mandal;
      document.getElementById('cd_mandal').value = profile.mandal;

      await fillActiveEventNames();
      await Promise.all([refreshMyEvents(), refreshMyReports(), refreshMyCoords(), refreshMyStats()]);
    }else{
      profile=null; appRoot.classList.add('hidden'); loginGate.classList.remove('hidden'); gateMsg.textContent="";
    }
  });

  logoutBtn.onclick = ()=> signOut(auth);

  // Active Event Names (isActive:true)
  async function fillActiveEventNames(){
    const snap = await getDocs(collection(db,"eventNames"));
    const active = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(e=>!!e.isActive)
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','hi'));
    ['ev_eventName','rp_eventName','cd_eventName'].forEach(id=>{
      const sel=document.getElementById(id); sel.innerHTML='<option value="">कार्यक्रम चुनें</option>';
      active.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; sel.appendChild(o); });
    });
  }

  // Helpers
  function badge(status){ const map={draft:'draft',pending_approval:'pending',live:'live'}; const cls=map[status]||'draft'; const lbl=status==='pending_approval'?'pending':(status||'draft'); return `<span class="badge ${cls}">${lbl}</span>`; }
  function csvDownload(filename, rows){ const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`; const csv=rows.map(r=>r.map(esc).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
  function filterRows(tbody, q){ const t=q.toLowerCase().trim(); Array.from(tbody.children).forEach(tr=>{ tr.style.display = tr.innerText.toLowerCase().includes(t)?'':''; }); }

  // EVENTS
  const ev = { sel:ev_eventName, date:ev_date, time:ev_time, loc:ev_location, msg:ev_msg, table:ev_table.querySelector('tbody'), search:ev_search, dl:ev_download };
  async function saveEvent(status){
    if(!profile) return; if(!ev.sel.value){ ev.msg.textContent='कार्यक्रम चुनें'; return; }
    await addDoc(collection(db,'events'), { eventNameId:ev.sel.value, mandal:profile.mandal, date:ev.date.value||'', time:ev.time.value||'', location:ev.loc.value||'', status, createdBy:profile.uid, createdAt:serverTimestamp() });
    ev.msg.textContent = status==='draft'?'Draft सेव हुआ':'Approval को भेज दिया गया'; await refreshMyEvents();
  }
  ev_saveDraft.onclick = ()=> saveEvent('draft'); ev_submit.onclick = ()=> saveEvent('pending_approval');
  async function refreshMyEvents(){
    ev.table.innerHTML=''; const snap=await getDocs(collection(db,'events')); const mine=[]; snap.forEach(d=>{ const x=d.data(); if(x.createdBy===profile?.uid) mine.push({id:d.id,ref:d.ref,...x}); });
    mine.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    mine.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.eventNameId}</td><td>${r.date||'-'}</td><td>${r.time||'-'}</td><td>${r.location||'-'}</td><td>${badge(r.status)}</td><td>${r.status!=='live'?'<button class="edit" data-type="event" data-id="'+r.id+'">Edit</button>':''}</td>`; ev.table.appendChild(tr); });
    ev.search.oninput = ()=> filterRows(ev.table, ev.search.value);
    ev.dl.onclick = ()=> csvDownload('events.csv',[['event','date','time','location','status'],...mine.map(r=>[r.eventNameId,r.date,r.time,r.location,r.status])]);
    ev.table.querySelectorAll('button.edit').forEach(b=>{ const obj=mine.find(x=>x.id===b.dataset.id); b.onclick=()=> openEdit('event',obj); });
  }

  // REPORTS
  const rp = { sel:rp_eventName, loc:rp_location, att:rp_attendance, date:rp_date, gst:rp_guests, det:rp_details, photo:rp_photo, msg:rp_msg, table:rp_table.querySelector('tbody'), search:rp_search, dl:rp_download };
  rp_saveDraft.onclick = ()=> saveReport('draft'); rp_submit.onclick = ()=> saveReport('pending_approval');
  async function saveReport(status){
    if(!profile) return; if(!rp.sel.value){ rp.msg.textContent='कार्यक्रम चुनें'; return; }
    let photos=[]; if(rp.photo.files?.length){ const f=rp.photo.files[0]; const sref=ref(storage,`reports/${rp.sel.value}/${Date.now()}_${f.name}`); await uploadBytes(sref,f); photos=[await getDownloadURL(sref)]; }
    await addDoc(collection(db,`eventNames/${rp.sel.value}/reports`), { eventNameId:rp.sel.value, mandal:profile.mandal, location:rp.loc.value||'', attendance:rp.att.value||'', date:rp.date.value||'', guests:rp.gst.value||'', details:rp.det.value||'', photos, status, createdBy:profile.uid, createdAt:serverTimestamp() });
    rp.msg.textContent = status==='draft'?'Draft सेव':'Approval को भेज दिया गया'; rp.photo.value=''; await refreshMyReports();
  }
  async function refreshMyReports(){
    rp.table.innerHTML=''; const evNames=await getDocs(collection(db,'eventNames')); const mine=[];
    for(const d of evNames.docs){ const sid=d.id; const rs=await getDocs(collection(db,`eventNames/${sid}/reports`)); rs.forEach(z=>{ const r=z.data(); if(r.createdBy===profile?.uid) mine.push({id:z.id,sid,ref:z.ref,...r}); }); }
    mine.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    mine.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.sid}</td><td>${r.date||'-'}</td><td>${r.attendance||'-'}</td><td>${badge(r.status)}</td><td>${r.status!=='live'?'<button class="edit" data-type="report" data-sid="'+r.sid+'" data-id="'+r.id+'">Edit</button>':''}</td>`; rp.table.appendChild(tr); });
    rp.search.oninput = ()=> filterRows(rp.table, rp.search.value);
    rp.dl.onclick = ()=> csvDownload('reports.csv',[['event','date','attendance','location','status'],...mine.map(r=>[r.sid,r.date,r.attendance,r.location,r.status])]);
    rp.table.querySelectorAll('button.edit').forEach(b=>{ const obj=mine.find(x=>x.id===b.dataset.id && x.sid===b.dataset.sid); b.onclick=()=> openEdit('report',obj); });
  }

  // COORDINATORS
  const cd = { sel:cd_eventName, name:cd_name, mob:cd_mobile, c1:cd_c1, c1m:cd_c1m, c2:cd_c2, c2m:cd_c2m, msg:cd_msg, table:cd_table.querySelector('tbody'), search:cd_search, dl:cd_download };
  cd_saveDraft.onclick = ()=> saveCoord('draft'); cd_submit.onclick = ()=> saveCoord('pending_approval');
  async function saveCoord(status){
    if(!profile) return; if(!cd.sel.value){ cd.msg.textContent='कार्यक्रम चुनें'; return; }
    await addDoc(collection(db,`eventNames/${cd.sel.value}/coordinators`), { eventNameId:cd.sel.value, mandal:profile.mandal, name:cd.name.value||'', mobile:cd.mob.value||'', coCoordName1:cd.c1.value||'', coCoordMobile1:cd.c1m.value||'', coCoordName2:cd.c2.value||'', coCoordMobile2:cd.c2m.value||'', status, createdBy:profile.uid, createdAt:serverTimestamp() });
    cd.msg.textContent = status==='draft'?'Draft सेव':'Approval को भेज दिया गया'; await refreshMyCoords();
  }
  async function refreshMyCoords(){
    cd.table.innerHTML=''; const evNames=await getDocs(collection(db,'eventNames')); const mine=[];
    for(const d of evNames.docs){ const sid=d.id; const cs=await getDocs(collection(db,`eventNames/${sid}/coordinators`)); cs.forEach(z=>{ const r=z.data(); if(r.createdBy===profile?.uid) mine.push({id:z.id,sid,ref:z.ref,...r}); }); }
    mine.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
    mine.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.sid}</td><td>${r.name||'-'}</td><td>${r.mobile||'-'}</td><td>${badge(r.status)}</td><td>${r.status!=='live'?'<button class="edit" data-type="coord" data-sid="'+r.sid+'" data-id="'+r.id+'">Edit</button>':''}</td>`; cd.table.appendChild(tr); });
    cd.search.oninput = ()=> filterRows(cd.table, cd.search.value);
    cd.dl.onclick = ()=> csvDownload('coordinators.csv',[['event','name','mobile','status'],...mine.map(r=>[r.sid,r.name,r.mobile,r.status])]);
    cd.table.querySelectorAll('button.edit').forEach(b=>{ const obj=mine.find(x=>x.id===b.dataset.id && x.sid===b.dataset.sid); b.onclick=()=> openEdit('coord',obj); });
  }

  // MY DASH
  async function refreshMyStats(){
    let eventsCnt=0,reportsCnt=0,coordsCnt=0; const liveRows=[];
    const es=await getDocs(collection(db,'events'));
    es.forEach(d=>{ const x=d.data(); if(x.mandal===profile?.mandal && x.status==='live'){ eventsCnt++; liveRows.push(['कार्यक्रम',x.eventNameId,`${x.date||'-'} ${x.time||''}`,x.location||'-']); }});
    const evNames=await getDocs(collection(db,'eventNames'));
    for(const d of evNames.docs){
      const sid=d.id;
      const rs=await getDocs(collection(db,`eventNames/${sid}/reports`));
      rs.forEach(z=>{ const r=z.data(); if(r.mandal===profile?.mandal && r.status==='live'){ reportsCnt++; liveRows.push(['रिपोर्ट',sid,r.date||'-',r.details||'-']); }});
      const cs=await getDocs(collection(db,`eventNames/${sid}/coordinators`));
      cs.forEach(z=>{ const r=z.data(); if(r.mandal===profile?.mandal && r.status==='live'){ coordsCnt++; liveRows.push(['संयोजक',sid,r.name||'-',r.mobile||'-']); }});
    }
    my_stats.innerHTML = `<div>Live कार्यक्रम: <b>${eventsCnt}</b></div><div>Live रिपोर्ट: <b>${reportsCnt}</b></div><div>Live संयोजक: <b>${coordsCnt}</b></div>`;
    const tbody=my_live.querySelector('tbody'); tbody.innerHTML=''; liveRows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`; tbody.appendChild(tr); });
    exportAll.onclick = ()=> csvDownload('live_all.csv',[['type','program','date/name','details'],...liveRows]);
    live_search.oninput = (e)=> filterRows(tbody, e.target.value);
  }

  // EDIT MODAL
  const em = { wrap:editModal, title:em_title, body:em_body, save:em_save, cancel:em_cancel, ctx:null };
  function openEdit(type,obj){
    em.ctx={type,obj}; em.title.textContent=`Edit ${type}`;
    if(type==='event'){ em.body.innerHTML=`<label>तारीख</label><input id="em_date" value="${obj.date||''}"><label>समय</label><input id="em_time" value="${obj.time||''}"><label>स्थान</label><input id="em_loc" value="${obj.location||''}">`; }
    else if(type==='report'){ em.body.innerHTML=`<label>तारीख</label><input id="em_date" value="${obj.date||''}"><label>उपस्थिति</label><input id="em_att" type="number" value="${obj.attendance||''}"><label>स्थान</label><input id="em_loc" value="${obj.location||''}"><label>विवरण</label><textarea id="em_det" rows="3">${obj.details||''}</textarea>`; }
    else { em.body.innerHTML=`<label>संयोजक</label><input id="em_name" value="${obj.name||''}"><label>मोबाइल</label><input id="em_mob" value="${obj.mobile||''}"><label>सह-संयोजक 1</label><input id="em_c1" value="${obj.coCoordName1||''}"><label>मोबाइल 1</label><input id="em_c1m" value="${obj.coCoordMobile1||''}"><label>सह-संयोजक 2</label><input id="em_c2" value="${obj.coCoordName2||''}"><label>मोबाइल 2</label><input id="em_c2m" value="${obj.coCoordMobile2||''}">`; }
    em.wrap.classList.remove('hidden');
  }
  em.cancel.onclick = ()=> em.wrap.classList.add('hidden');
  em.save.onclick = async ()=>{
    const {type,obj}=em.ctx||{}; if(!type) return; const base={status:'pending_approval'};
    if(type==='event'){ await updateDoc(obj.ref,{...base,date:em_date.value,time:em_time.value,location:em_loc.value}); await refreshMyEvents(); }
    else if(type==='report'){ await updateDoc(obj.ref,{...base,date:em_date.value,attendance:em_att.value,location:em_loc.value,details:em_det.value}); await refreshMyReports(); }
    else { await updateDoc(obj.ref,{...base,name:em_name.value,mobile:em_mob.value,coCoordName1:em_c1.value,coCoordMobile1:em_c1m.value,coCoordName2:em_c2.value,coCoordMobile2:em_c2m.value}); await refreshMyCoords(); }
    em.wrap.classList.add('hidden');
  };
</script>
</body>
</html>
