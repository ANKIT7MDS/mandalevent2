<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    body{font-family:system-ui,'Noto Sans Devanagari',Arial,sans-serif;background:#fff9f3;margin:0}
    .wrap{max-width:1200px;margin:20px auto;background:#fff6ea;border-radius:14px;box-shadow:0 2px 16px #ff980020;padding:16px}
    h1,h2{color:#e65100} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ffa72655;padding:7px} th{background:#ffb74d}
    button{background:#ff9800;border:none;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer} button.danger{background:#e53935}
    .toolbar{display:flex;gap:8px;align-items:center;margin:.4rem 0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>एडमिन डैशबोर्ड</h1>

  <h2>कार्यक्रम (eventNames) — ड्रॉपडाउन कंट्रोल</h2>
  <div class="toolbar">
    <input id="newEvName" placeholder="नया कार्यक्रम नाम">
    <button id="addEvBtn">जोड़ें</button>
  </div>
  <table id="evnames"><thead><tr><th>नाम</th><th>isActive</th></tr></thead><tbody></tbody></table>

  <h2 style="margin-top:20px">Pending Approvals</h2>
  <table id="pending"><thead><tr><th>टाइप</th><th>कार्यक्रम</th><th>मंडल</th><th>By</th><th>Action</th></tr></thead><tbody></tbody></table>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href='index-mandal-final.html'; return; }
    const u = await getDoc(doc(db,'users',user.uid));
    if(!u.exists() || u.data().role!=='admin'){ location.href='index-mandal-final.html'; return; }
    await Promise.all([loadEventNames(), loadPending()]);
  });

  // Event names table
  const tBody = document.querySelector('#evnames tbody');
  async function loadEventNames(){
    tBody.innerHTML='';
    const snap = await getDocs(collection(db,'eventNames'));
    const rows = snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||'','hi'));
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.name||r.id}</td><td><input type="checkbox" ${r.isActive?'checked':''}></td>`;
      const chk=tr.querySelector('input'); chk.onchange=()=> updateDoc(doc(db,'eventNames',r.id),{isActive:chk.checked});
      tBody.appendChild(tr);
    });
  }
  document.getElementById('addEvBtn').onclick = async ()=>{
    const name=document.getElementById('newEvName').value.trim(); if(!name) return;
    await addDoc(collection(db,'eventNames'), {name, isActive:true});
    document.getElementById('newEvName').value=''; loadEventNames();
  };

  // Pending approvals
  const pBody = document.querySelector('#pending tbody');
  async function loadPending(){
    pBody.innerHTML='';

    // events
    const es=await getDocs(collection(db,'events'));
    es.forEach(d=>{ const x=d.data(); if(x.status==='pending_approval'){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>कार्यक्रम</td><td>${x.eventNameId}</td><td>${x.mandal}</td><td>${x.createdBy}</td>
        <td><button class="ap">Approve</button> <button class="rj danger">Reject</button></td>`;
      tr.querySelector('.ap').onclick = ()=> updateDoc(d.ref,{status:'live'}).then(loadPending);
      tr.querySelector('.rj').onclick = ()=> updateDoc(d.ref,{status:'rejected'}).then(loadPending);
      pBody.appendChild(tr);
    }});

    // reports + coordinators
    const evs=await getDocs(collection(db,'eventNames'));
    for(const n of evs.docs){
      const sid=n.id;

      const rs=await getDocs(collection(db,`eventNames/${sid}/reports`));
      rs.forEach(z=>{ const r=z.data(); if(r.status==='pending_approval'){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>रिपोर्ट</td><td>${sid}</td><td>${r.mandal}</td><td>${r.createdBy}</td>
          <td><button class="ap">Approve</button> <button class="rj danger">Reject</button></td>`;
        tr.querySelector('.ap').onclick=()=> updateDoc(z.ref,{status:'live'}).then(loadPending);
        tr.querySelector('.rj').onclick=()=> updateDoc(z.ref,{status:'rejected'}).then(loadPending);
        pBody.appendChild(tr);
      }});

      const cs=await getDocs(collection(db,`eventNames/${sid}/coordinators`));
      cs.forEach(z=>{ const r=z.data(); if(r.status==='pending_approval'){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>संयोजक</td><td>${sid}</td><td>${r.mandal}</td><td>${r.createdBy}</td>
          <td><button class="ap">Approve</button> <button class="rj danger">Reject</button></td>`;
        tr.querySelector('.ap').onclick=()=> updateDoc(z.ref,{status:'live'}).then(loadPending);
        tr.querySelector('.rj').onclick=()=> updateDoc(z.ref,{status:'rejected'}).then(loadPending);
        pBody.appendChild(tr);
      }});
    }
  }
</script>
</body>
</html>
